---
title: Google Cloud Messaging
description: Google Cloud Messaging (GCM) — это служба, которая упрощает обмен сообщениями между мобильными приложениями и серверных приложений. В этой статье приводятся общие сведения о работе GCM и объясняется, как настроить службы Google, чтобы приложение могла использовать GCM.
ms.prod: xamarin
ms.assetid: DF8EF401-F63D-4BA0-B2C6-B22DF8FD60CB
ms.technology: xamarin-android
author: davidortinau
ms.author: daortin
ms.date: 05/02/2019
ms.openlocfilehash: e9b0337c9cdcfbd8f738a11c5dffff427df620bc
ms.sourcegitcommit: db422e33438f1b5c55852e6942c3d1d75dc025c4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2020
ms.locfileid: "76723665"
---
# <a name="google-cloud-messaging"></a>Google Cloud Messaging

> [!WARNING]
> Нерекомендуемый GCM в Google с 10 апреля 2018 г. Следующие документы и образцы проектов могут больше не поддерживаться. API сервера и клиента GCM Google будут удалены сразу после 29 мая 2019. Google рекомендует перенести приложения GCM в Firebase Cloud Messaging (FCM). Дополнительные сведения об устаревании и миграции GCM см. в статье [нерекомендуемый облачный обмен сообщениями в Google](https://developers.google.com/cloud-messaging/).
>
> Чтобы приступить к использованию облачной службы обмена сообщениями Firebase с Xamarin, см. статью [Firebase Cloud Messaging](firebase-cloud-messaging.md).

_Google Cloud Messaging (GCM) — это служба, которая упрощает обмен сообщениями между мобильными приложениями и серверных приложений. В этой статье приводятся общие сведения о работе GCM и объясняется, как настроить службы Google, чтобы приложение могла использовать GCM._

[![Google Cloud Messaging логотип](google-cloud-messaging-images/preview-sml.png)](google-cloud-messaging-images/preview.png#lightbox)

В этом разделе представлен общий обзор того, как Google Cloud Messaging маршрутизирует сообщения между приложением и сервером приложений и предоставляет пошаговую процедуру для получения учетных данных, чтобы приложение может использовать службы GCM.

## <a name="overview"></a>Обзор

Google Cloud Messaging (GCM) — это служба, которая обрабатывает отправку, маршрутизацию и очередь сообщений между серверными приложениями и мобильными клиентскими приложениями. *Клиентское приложение* — это приложение с поддержкой GCM, которое выполняется на устройстве. *Сервер приложений* (предоставленный вами или вашей организацией) — это сервер с поддержкой GCM, с которым клиентское приложение взаимодействует через gcm:

[![GCM находится между клиентским приложением и сервером приложений](google-cloud-messaging-images/01-server-gcm-app-sml.png)](google-cloud-messaging-images/01-server-gcm-app.png#lightbox)

С помощью GCM серверы приложений могут отсылать сообщения на одно устройство, группу устройств или на несколько устройств, подписанных на раздел. Клиентское приложение может использовать GCM для подписки на подчиненные сообщения с сервера приложений (например, для получения удаленных уведомлений). Кроме того, GCM позволяет клиентским приложениям передавать вышестоящее сообщение обратно на сервер приложений.

## <a name="google-cloud-messaging-in-action"></a>Google Cloud Messaging в действии

При отправке подчиненных сообщений с сервера приложений в клиентское приложение сервер приложений отправляет сообщение на *сервер подключения gcm*; сервер подключения GCM, в свою очередь, перенаправляет сообщение на устройство, на котором выполняется клиентское приложение. Сообщения можно отправлять по протоколу HTTP или [XMPP](https://firebase.google.com/docs/cloud-messaging/xmpp-server-ref) (расширенный протокол обмена сообщениями и протокола присутствия). Поскольку клиентские приложения не всегда подключены или выполняются, сервер подключения GCM ставит в очередь и сохраняет сообщения, отправляя их в клиентские приложения при повторном подключении и доступности. Аналогичным образом GCM помещает в очередь вышестоящее сообщение от клиентского приложения к серверу приложений, если сервер приложений недоступен.

GCM использует следующие учетные данные для указания сервера приложений и клиентского приложения и использует эти учетные данные для авторизации транзакций сообщений через GCM:

- **Ключ api** &ndash; *ключ API* предоставляет серверу приложений доступ к службам Google. GCM использует этот ключ для проверки подлинности сервера приложений.
    Перед использованием службы GCM необходимо сначала получить ключ API из [консоли Google Developer](https://console.developers.google.com/) , создав *проект*. Ключ API должен обеспечивать безопасность; Дополнительные сведения о защите ключа API см. в статье рекомендации [по безопасному использованию ключей API](https://support.google.com/cloud/answer/6310037?hl=en).

- **Идентификатор отправителя** &ndash; *идентификатор отправителя* разрешает серверу приложений клиентское приложение &ndash; это уникальный номер, идентифицирующий сервер приложений, которому разрешено отправку сообщений в клиентское приложение.
    Идентификатор отправителя также является номером вашего проекта; При регистрации проекта вы получаете идентификатор отправителя из консоли разработчиков Google.

- **Маркер регистрации** &ndash; *маркер регистрации* — это удостоверение gcm клиентского приложения на заданном устройстве. Маркер регистрации создается во время выполнения, &ndash; приложение получает маркер регистрации при первой регистрации в GCM во время выполнения на устройстве. Маркер регистрации авторизует экземпляр клиентского приложения (выполняющегося на этом конкретном устройстве) для получения сообщений от GCM.

- **Идентификатор приложения** &ndash; удостоверение клиентского приложения (независимо от любого устройства), которое регистрируется для получения сообщений от gcm. В Android идентификатор приложения — это имя пакета, записанное в **AndroidManifest. XML**, например `com.xamarin.gcmexample`.

[Настройка Google Cloud Messaging](#settingup) (далее в этом пошаговом окне) содержит подробные инструкции по созданию проекта и созданию этих учетных данных.

В следующих разделах объясняется, как эти учетные данные используются при взаимодействии клиентских приложений с серверами приложений через GCM.

### <a name="registration-with-gcm"></a>Регистрация в GCM

Клиентское приложение, установленное на устройстве, должно сначала зарегистрироваться в GCM до того, как система обмена сообщениями может быть выполнена. Клиентское приложение должно выполнить действия по регистрации, показанные на следующей схеме:

[действия ![регистрации приложений](google-cloud-messaging-images/02-app-registration-sml.png)](google-cloud-messaging-images/02-app-registration.png#lightbox)

1. Клиентское приложение обращается к GCM, чтобы получить маркер регистрации, передав идентификатор отправителя в GCM.

2. GCM возвращает маркер регистрации клиентскому приложению.

3. Клиентское приложение перенаправляет маркер регистрации на сервер приложений.

Сервер приложений кэширует маркер регистрации для последующего взаимодействия с клиентским приложением. При необходимости сервер приложений может отправить подтверждение обратно в клиентское приложение, чтобы указать, что получен маркер регистрации. После выполнения этого подтверждения клиентское приложение может получать сообщения от сервера приложений (или отправлять сообщения на него).

Когда клиентскому приложению больше не требуется получать сообщения с сервера приложений, оно может отправить запрос на сервер приложений для удаления маркера регистрации. Если клиентское приложение получает сообщения раздела (описанные далее в этой статье), оно может отказаться от подписки на раздел.
Если клиентское приложение удалено с устройства, GCM обнаруживает это и автоматически уведомляет сервер приложений об удалении маркера регистрации.

### <a name="downstream-messaging"></a>Подчиненный обмен сообщениями

Когда сервер приложений отправляет в клиентское приложение подчиненное сообщение, оно проходит шаги, показанные на следующей схеме:

[![в подчиненном хранилище сообщений и схеме пересылки](google-cloud-messaging-images/03-downstream-sml.png)](google-cloud-messaging-images/03-downstream.png#lightbox)

1. Сервер приложений отправляет сообщение в GCM.

2. Если клиентское устройство недоступно, сервер GCM сохраняет сообщение в очереди для последующей передачи.

3. Когда клиентское устройство будет доступно, GCM отправляет это сообщение клиентскому приложению на этом устройстве.

4. Клиентское приложение получает сообщение от GCM и соответствующим образом обрабатывает его. Например, если сообщение представляет собой удаленное уведомление, оно будет представлено пользователю.

В этом сценарии обмена сообщениями (где сервер приложений отправляет сообщение в одно клиентское приложение) размер сообщений может доставлять до 4 КБ.

Подробные сведения (включая примеры кода) о получении подчиненных сообщений GCM в Android см. в разделе [Удаленные уведомления](~/android/data-cloud/google-messaging/remote-notifications-with-gcm.md).

#### <a name="topic-messaging"></a>Обмен сообщениями с темой

*Обмен сообщениями с темой* — это тип подчиненного обмена сообщениями, в котором сервер приложений отправляет одно сообщение нескольким клиентским приложениям, которые подписываются на раздел (например, прогноз погоды). Сообщения в разделе могут быть 2 КБ в длину, а сообщения раздела поддерживают до 1 000 000 подписок на приложение. Если GCM используется только для обмена сообщениями с разделами, клиентскому приложению не требуется передавать маркер регистрации на сервер приложений.

#### <a name="group-messaging"></a>Обмен сообщениями группы

*Обмен сообщениями групп* — это тип подчиненного обмена сообщениями, в котором сервер приложений отправляет одно сообщение нескольким клиентским приложениям, принадлежащим к группе (например, группе устройств, принадлежащих одному пользователю). Размер сообщений группы может доставлять до 2 КБ для устройств iOS и до 4 КБ для устройств Android. Группа ограничена максимум 20 участниками.

### <a name="upstream-messaging"></a>Потоковая передача сообщений

Если клиентское приложение подключается к серверу, который поддерживает [XMPP](https://firebase.google.com/docs/cloud-messaging/xmpp-server-ref), он может отправить сообщения обратно на сервер приложений, как показано на следующей схеме:

[![ная диаграмма обмена сообщениями](google-cloud-messaging-images/04-upstream-sml.png)](google-cloud-messaging-images/04-upstream.png#lightbox)

1. Клиентское приложение отправляет сообщение на сервер подключения GCM XMPP.

2. Если сервер приложений отключен, сервер GCM сохраняет сообщение в очереди для последующей пересылки.

3. При повторном подключении сервера приложений GCM передает сообщение на сервер приложений.

4. Сервер приложений анализирует сообщение, чтобы проверить подлинность клиентского приложения, а затем отправляет "ACK" в GCM для подтверждения получения сообщения.

5. Сервер приложений обрабатывает сообщение.

В [вышестоящем сообщении](https://firebase.google.com/docs/cloud-messaging/xmpp-server-ref#upstream) Google объясняется, как структурировать сообщения в кодировке JSON и отправить их на серверы приложений, на которых выполняется облачный сервер подключения Google XMPP.

<a name="settingup" />

## <a name="setting-up-google-cloud-messaging"></a>Настройка Google Cloud Messaging

Прежде чем вы сможете использовать службы GCM в своем приложении, сначала необходимо получить учетные данные для доступа к серверам GCM Google. В следующих разделах описаны шаги, необходимые для выполнения этого процесса.

### <a name="enable-google-services-for-your-app"></a>Включение служб Google для приложения

1. Войдите в [консоль разработчиков Google](https://developers.google.com/mobile/add?platform=android) с помощью учетной записи Google (например, адреса Gmail) и создайте новый проект. Если у вас уже есть проект, выберите проект, который требуется включить в GCM. В следующем примере создается новый проект с именем **ксамарингкм** :

    [![создания проекта Ксамарингкм](google-cloud-messaging-images/05-create-gcm-app-sml.png)](google-cloud-messaging-images/05-create-gcm-app.png#lightbox)

2. Затем введите имя пакета для своего приложения (в этом примере — имя пакета — **com. Xamarin. гкмексампле**) и нажмите кнопку **продолжить, чтобы выбрать и настроить службы**:

    [![ввода имени пакета](google-cloud-messaging-images/06-package-name-sml.png)](google-cloud-messaging-images/06-package-name.png#lightbox)

    Обратите внимание, что это имя пакета также является ИДЕНТИФИКАТОРом приложения для приложения.

3. В разделе **Выбор и Настройка служб** перечислены службы Google, которые можно добавить в приложение. Щелкните **облачная система обмена сообщениями**.

    [![выбор облачных сообщений](google-cloud-messaging-images/07-choose-gcm-service-sml.png)](google-cloud-messaging-images/07-choose-gcm-service.png#lightbox)

4. Затем щелкните **включить Google Cloud MESSAGING**.

    [![включить Google Cloud Messaging](google-cloud-messaging-images/08-enable-gcm-sml.png)](google-cloud-messaging-images/08-enable-gcm.png#lightbox)

5. Для приложения создаются **ключ API сервера** и **идентификатор отправителя** . Запишите эти значения и нажмите кнопку **Закрыть**:

    [отображаемый ключ API сервера ![и идентификатор отправителя](google-cloud-messaging-images/09-get-api-key-and-id-sml.png)](google-cloud-messaging-images/09-get-api-key-and-id.png#lightbox)

    Защитите ключ API &ndash; он не предназначен для общедоступного использования. Если ключ API скомпрометирован, Неавторизованные серверы могут публиковать сообщения в клиентских приложениях.
    Рекомендации по [безопасному использованию ключей API](https://support.google.com/cloud/answer/6310037?hl=en) предоставляют полезные рекомендации по защите ключа API.

### <a name="view-your-project-settings"></a>Просмотр параметров проекта

Вы можете просмотреть параметры проекта в любое время, войдя в [консоль Google Cloud](https://console.cloud.google.com/) и выбрав свой проект. Например, можно просмотреть **идентификатор отправителя** , выбрав проект в раскрывающемся меню в верхней части страницы (в этом примере проект называется **ксамарингкм**). Идентификатор отправителя — это номер проекта, как показано на следующем снимке экрана (идентификатор отправителя — **9349932736**):

[![просмотре идентификатора отправителя](google-cloud-messaging-images/10-view-server-id-sml.png)](google-cloud-messaging-images/10-view-server-id.png#lightbox)

Чтобы просмотреть **ключ API**, щелкните **Диспетчер API** , а затем — **учетные данные**:

[![просмотре ключа API](google-cloud-messaging-images/11-view-credentials-sml.png)](google-cloud-messaging-images/11-view-credentials.png#lightbox)

## <a name="for-further-reading"></a>Дополнительные сведения

- [Rfc 6120](https://tools.ietf.org/html/rfc6120) и [RFC 6121](https://tools.ietf.org/html/rfc6121) объясняют и определяют расширяемый протокол обмена сообщениями и присутствия (XMPP).

## <a name="summary"></a>Сводка

В этой статье представлен обзор Google Cloud Messaging (GCM). В нем объясняются различные учетные данные, используемые для обнаружения и авторизации обмена сообщениями между серверами приложений и клиентскими приложениями. В нем проиллюстрированы наиболее распространенные сценарии обмена сообщениями и подробно описаны действия по регистрации приложения в GCM для использования служб GCM.

## <a name="related-links"></a>Связанные ссылки

- [Облачная система обмена сообщениями](https://developers.google.com/cloud-messaging/)
