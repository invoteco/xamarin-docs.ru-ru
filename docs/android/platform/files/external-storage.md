---
title: Доступ к файлам во внешнем хранилище с использованием Xamarin.Android
description: В этом руководстве описывается доступ в Xamarin.Android к файлам во внешнем хранилище
ms.prod: xamarin
ms.assetid: 40da10b2-a207-4f9c-a2dd-165d9b662f33
ms.technology: xamarin-android
author: davidortinau
ms.author: daortin
ms.date: 07/23/2018
ms.openlocfilehash: 96b0d6a00c7825939b1f89ed63e3e5559ca4ef59
ms.sourcegitcommit: b0ea451e18504e6267b896732dd26df64ddfa843
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/13/2020
ms.locfileid: "73020484"
---
# <a name="external-storage"></a>Внешнее хранилище

Внешнее хранилище относится к хранилищу файлов, которое находится не во внутреннем хранилище и доступно не только для приложения, отвечающего за файл. Основное предназначение внешнего хранилища — предоставление места для размещения файлов для совместного использования приложениями или файлов слишком большого размера для внутреннего хранилища.

Ранее внешним хранилищем назывался раздел диска на съемном носителе, таком как SD-карта (также известном как _переносное устройство_). Это различие уже неактуально, так как устройства Android существенно изменились и многие устройства Android больше не поддерживают съемные носители. Вместо этого некоторые устройства будут выделять часть внутренней энергонезависимой памяти, которую Android использует для выполнения той же функции съемного носителя. Это называется _эмулированным_ хранилищем и по-прежнему считается внешним. Кроме того, у некоторых устройств Android может быть несколько внешних разделов хранилища. Например, в планшете Android (помимо его внутреннего хранилища) может быть эмулированное хранилище и один или несколько слотов для SD-карты. Все эти разделы рассматриваются Android как внешнее хранилище.

На устройствах с несколькими пользователями у каждого пользователя будет выделенный каталог в основном разделе внешнего хранилища для внешнего хранилища. Приложения, в которых работает один пользователь, не будут иметь доступа к файлам другого пользователя на устройстве. Файлы для всех пользователей по-прежнему будут доступны всем для чтения и записи. Тем не менее, Android будет изолировать каждый профиль пользователя от других.

В Xamarin.Android чтение и запись в файлы практически идентична этим процессам в любых других приложениях .NET. Приложение Xamarin.Android определяет путь к файлу, который будет обработан, а затем использует стандартные идиомы .NET для доступа к файлам. Так как фактические пути к внутреннему и внешнему хранилищу могут отличаться в зависимости от устройства или от версии Android, не рекомендуется жестко задавать путь к файлам. Вместо этого Xamarin.Android предоставляет собственные API Android, которые помогут определить путь к файлам во внутреннем и внешнем хранилище.

В этом руководстве описываются основные понятия и API в Android, относящиеся к внешнему хранилищу.

## <a name="public-and-private-files-on-external-storage"></a>Общедоступные и частные файлы во внешнем хранилище

Существует два разных типа файлов, которые приложение может хранить во внешнем хранилище:

* **Частные** файлы — это файлы, зависящие от приложения (но все еще доступные всем для чтения и записи). В Android предполагается, что частные файлы хранятся в определенном каталоге во внешнем хранилище. Несмотря на то, что файлы называются "частными", они по-прежнему видимы и доступны для других приложений на устройстве, Android не предоставляет им специальные меры защиты.

* **Общедоступные** файлы — это файлы, которые не считаются зависящими от приложения и предназначены для свободного использования.

Разница между этими файлами в основном концептуальная. Файлы являются частными, так как они считаются частью приложения, в то время как общедоступные файлы — это любые другие файлы, которые существуют во внешнем хранилище. Android предоставляет два разных API-интерфейса для разрешения путей к частным и общедоступным файлам, но в остальном для чтения и записи в эти файлы используются одни и те же интерфейсы API .NET. Это те же API-интерфейсы, которые рассматриваются в разделе о [чтении и записи](~/android/platform/files/index.md#reading-or-writing-to-files-on-internal-storage).

### <a name="private-external-files"></a>Частные внешние файлы

Частные внешние файлы считаются привязанными к приложению (аналогично внутренним файлам), но содержатся во внешнем хранилище по разным причинам (например, файлы слишком большие для внутреннего хранилища). Как и внутренние файлы, эти файлы будут удалены, если пользователь удалит приложение.

Основное расположение для частных внешних файлов определяется путем вызова метода `Android.Content.Context.GetExternalFilesDir(string type)`. Этот метод возвращает объект `Java.IO.File`, представляющий частный каталог во внешнем хранилище для приложения. Передача `null` этому методу приведет к возвращению пути к каталогу хранилища пользователя для приложения. Например, для приложения с именем пакета `com.companyname.app` корневой каталог частных внешних файлов будет таким:

```bash
/storage/emulated/0/Android/data/com.companyname.app/files/
```

В этом документе будут ссылки на каталог хранилища частных файлов во внешнем хранилище как на _PRIVATE\_EXTERNAL\_STORAGE_.

Параметр для `GetExternalFilesDir()` представляет собой строку, которая указывает _каталог приложения_. Этот каталог предназначен для стандартного расположения в логической организации файлов. Строковые значения доступны через константы класса `Android.OS.Environment`:

| `Android.OS.Environment` | Каталог |
|-|-|
| DirectoryAlarms | **_PRIVATE\_EXTERNAL\_STORAGE_/Alarms** |
| DirectoryDcim | **_PRIVATE\_EXTERNAL\_STORAGE_/DCIM** |
| DirectoryDownloads | **_PRIVATE\_EXTERNAL\_STORAGE_/Download** |
| DirectoryDocuments | **_PRIVATE\_EXTERNAL\_STORAGE_/Documents** |
| DirectoryMovies | **_PRIVATE\_EXTERNAL\_STORAGE_/Movies** |
| DirectoryMusic | **_PRIVATE\_EXTERNAL\_STORAGE_/Music** |
| DirectoryNotifications | **_PRIVATE\_EXTERNAL\_STORAGE_/Notifications** |
| DirectoryPodcasts | **_PRIVATE\_EXTERNAL\_STORAGE_/Podcasts** |
| DirectoryRingtones | **_PRIVATE\_EXTERNAL\_STORAGE_/Ringtones** |
| DirectoryPictures | **_PRIVATE\_EXTERNAL\_STORAGE_/Pictures** |

Для устройств с несколькими разделами во внешнем хранилище каждый раздел будет содержать каталог, предназначенный для частных файлов. Метод `Android.Content.Context.GetExternalFilesDirs(string type)` возвращает массив `Java.IO.Files`. Каждый объект будет представлять частный каталог приложения для всех совместно используемых устройств с внешними хранилищами, где приложение может размещать принадлежащие ему файлы.

> [!IMPORTANT]
> Точный путь к частному каталогу внешнего хранилища может отличаться в зависимости от устройства и версии Android. По этой причине приложения не должны жестко задавать путь к этому каталогу. Вместо этого они должны использовать API-интерфейсы Xamarin.Android, например `Android.Content.Context.GetExternalFilesDir()`.

### <a name="public-external-files"></a>Общедоступные внешние файлы

Общедоступные файлы — это файлы, которые существуют во внешнем хранилище и не хранятся в каталоге, который Android выделяет для частных файлов. Общедоступные файлы не удаляются при удалении приложения. Приложения Android должны получить разрешение, прежде чем они смогут считывать или записывать любые общедоступные файлы. Общедоступные файлы могут существовать везде во внешнем хранилище, но по соглашению в Android предусматривается, что общедоступные файлы будут существовать в каталоге, указанном свойством `Android.OS.Environment.ExternalStorageDirectory`. Это свойство будет возвращать объект `Java.IO.File`, который представляет основной каталог во внешнем хранилище. В качестве примера `Android.OS.Environment.ExternalStorageDirectory` может ссылаться на следующий каталог:

```bash
/storage/emulated/0/
```

В этом документе будут ссылки на каталог хранилища общедоступных файлов во внешнем хранилище как на _PUBLIC\_EXTERNAL\_STORAGE_.

Android также поддерживает концепцию каталогов приложений для _PUBLIC\_EXTERNAL\_STORAGE_. Эти каталоги в точности совпадают с каталогами приложений для `PRIVATE_EXTERNAL_STORAGE` и описаны в таблице в предыдущем разделе. Метод `Android.OS.Environment.GetExternalStoragePublicDirectory(string directoryType)` возвращает объект `Java.IO.File`, который соответствует общедоступному каталогу приложения. Параметр `directoryType` является обязательным и не может иметь значение `null`.

Например, вызов `Environment.GetExternalStoragePublicDirectory(Environment.DirectoryDocuments).AbsolutePath` вернет строку, которая будет выглядеть так:

```bash
/storage/emulated/0/Documents
```

> [!IMPORTANT]
> Точный путь к общедоступному каталогу во внешнем хранилище может отличаться в зависимости от устройства и версии Android. По этой причине приложения не должны жестко задавать путь к этому каталогу. Вместо этого они должны использовать API-интерфейсы Xamarin.Android, например `Android.OS.Environment.ExternalStorageDirectory`.

## <a name="working-with-external-storage"></a>Работа с внешним хранилищем

Как только приложение Xamarin.Android получит полный путь к файлу, оно должно использовать любой из стандартных API-интерфейсов .NET для создания, чтения, записи или удаления файлов. Это увеличивает объем кроссплатформенного кода для приложения. Тем не менее, прежде чем пытаться получить доступ к файлу, для приложения Xamarin.Android необходимо убедиться, что к этому файлу можно осуществлять доступ.

1. **Проверка внешнего хранилища**. В зависимости от характера внешнего хранилища существует возможность, что оно не будет подключено и не будет использоваться приложением. Все приложения должны проверять состояние внешнего хранилища, прежде чем пытаться его использовать.
2. **Выполнение проверки разрешений во время выполнения**. Приложение Android должно запросить разрешение у пользователя для доступа к внешнему хранилищу. Это означает, что запрос на разрешение во время выполнения должен быть сделан до осуществления любого доступа к файлу. Руководство [Разрешения в Xamarin.Android](~/android/app-fundamentals/permissions.md) содержит более подробные сведения о разрешениях Android.

Каждая из этих двух задач будет описана ниже.

### <a name="verifying-that-external-storage-is-available"></a>Проверка доступности внешнего хранилища

Первым действием перед записью во внешнее хранилище является проверка его доступности для чтения или записи. Свойство `Android.OS.Environment.ExternalStorageState` содержит строку для определения состояния внешнего хранилища. Это свойство будет возвращать строку, которая представляет состояние. Эта таблица представляет собой список значений `ExternalStorageState`, которые могут быть возвращены `Environment.ExternalStorageState`:

| ExternalStorageState | Описание  |
|----------------------|---|
| MediaBadRemoval      | Носитель внезапно удален без отключения надлежащим образом. |
| MediaChecking        | Носитель присутствует, но проходит проверку диска.  |
| MediaEjecting        | Носитель пребывает в процессе отключения и извлечения.  |
| MediaMounted         | Носитель подключен, в нем можно выполнять операции чтения и записи.  |
| MediaMountedReadOnly | Носитель подключен, но в нем можно выполнять только операции чтения. |
| MediaNofs            | Носитель присутствует, но не содержит файловой системы, подходящей для Android. |
| MediaRemoved         | Носитель отсутствует. |
| MediaShared          | Носитель присутствует, но не подключен. Его использует через USB-порт другое устройство.|
| MediaUnknown         | Состояние носителя не распознано Android. |
| MediaUnmountable     | Носитель присутствует, но его не удалось подключить к Android. |
| MediaUnmounted       | Носитель присутствует, но отключен. |

Большинству приложений Android нужно будет только проверить, подключено ли внешнее хранилище. В следующем фрагменте кода показано, как проверить, подключено внешнее хранилище только для чтения или для чтения и записи:

```csharp
bool isReadonly = Environment.MediaMountedReadOnly.Equals(Environment.ExternalStorageState);
bool isWriteable = Environment.MediaMounted.Equals(Environment.ExternalStorageState);
```

## <a name="external-storage-permissions"></a>Разрешения внешнего хранилища

Android рассматривает доступ к внешнему хранилищу как _опасное разрешение_, поэтому обычно запрашивает у пользователя предоставление разрешения на доступ к ресурсу. Пользователь может отозвать это разрешение в любое время.  Это означает, что запрос на разрешение во время выполнения должен быть сделан до осуществления любого доступа к файлу. Приложениям автоматически предоставляются разрешения на чтение и запись собственных частных файлов. Приложения могут считывать и записывать частные файлы, принадлежащие другим приложениям, после [получения разрешения](~/android/app-fundamentals/permissions.md) от пользователя.

Все приложения Android должны объявить одно из двух разрешений для внешнего хранилища в **AndroidManifest.xml**. Чтобы определить разрешения, один из следующих двух элементов `uses-permission` должен быть добавлен в **AndroidManifest.xml**:

```xml
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
```

> [!NOTE]
> Если пользователь предоставил разрешение `WRITE_EXTERNAL_STORAGE`, то также неявно предоставляется и `READ_EXTERNAL_STORAGE`. Нет необходимости запрашивать оба разрешения в **AndroidManifest.xml**.

# <a name="visual-studio"></a>[Visual Studio](#tab/windows)

Разрешения также можно добавить на вкладке **Манифест Android** в разделе **свойств решения**:

![Обозреватель решений — необходимые разрешения для Visual Studio](./images/required-permissions.w157.png)

# <a name="visual-studio-for-mac"></a>[Visual Studio для Mac](#tab/macos)

Разрешения также можно добавить с помощью вкладки **Манифест Android** на **панели свойств решения**:

[![Панель решения — необходимые разрешения для Visual Studio для Mac](./images/required-permissions.m752-sml.png)](./images/required-permissions.m752.png#lightbox)

-----

В общем, все опасные разрешения подлежат одобрению пользователем. Разрешения для внешнего хранилища являются аномалией в том смысле, что есть исключения из этого правила в зависимости от версии Android, на которой работает приложение:

![Блок-схема проверок разрешений для внешнего хранилища](./images/external-permission-check-flowchart.png)

Дополнительные сведения о запросах на разрешения во время выполнения см. в руководстве [Разрешения в Xamarin.Android](~/android/app-fundamentals/permissions.md). [LocalFiles](https://github.com/xamarin/monodroid-samples/tree/master/LocalFiles) **monodroid-sample** также демонстрирует один из способов проверки разрешений во время выполнения.

#### <a name="granting-and-revoking-permissions-with-adb"></a>Предоставление и отмена разрешений с помощью adb

Во время разработки приложения Android может потребоваться предоставить и отменить разрешения для проверки различных рабочих процессов, связанных с проверкой разрешений во время выполнения. Для этого можно использовать командную строку и adb. В следующих фрагментах командной строки показано, как предоставлять или отменять разрешения с помощью adb для приложения Android, имя пакета которого — **com.companyname.app**:

```bash
$ adb shell pm grant com.companyname.app android.permission.WRITE_EXTERNAL_STORAGE

$ adb shell pm revoke com.companyname.app android.permission.WRITE_EXTERNAL_STORAGE
```

## <a name="deleting-files"></a>Удаление файлов

Любой из стандартных API-интерфейсов C# можно использовать для удаления файла из внешнего хранилища, например [`System.IO.File.Delete`](xref:System.IO.File.Delete*). Для этого также можно использовать API-интерфейсы Java за счет переносимости кода. Пример:

```csharp
System.IO.File.Delete("/storage/emulated/0/Android/data/com.companyname.app/files/count.txt");
```

## <a name="related-links"></a>Связанные ссылки

* [Пример локальных файлов Xamarin.Android в **monodroid-samples**](https://github.com/xamarin/monodroid-samples/tree/master/LocalFiles)
* [Разрешения в Xamarin.Android](~/android/app-fundamentals/permissions.md)
