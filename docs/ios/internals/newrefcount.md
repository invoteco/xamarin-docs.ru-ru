---
title: Новая система подсчета ссылок в Xamarin. iOS
description: Этот документ описывает систему подсчета улучшенных ссылок Xamarin, включенную во всех приложениях Xamarin. iOS по умолчанию.
ms.prod: xamarin
ms.assetid: 0221ED8C-5382-4C1C-B182-6C3F3AA47DB1
ms.technology: xamarin-ios
author: davidortinau
ms.author: daortin
ms.date: 11/25/2015
ms.openlocfilehash: 8d8ad5b5f79b90fc415c9e3cdf6809a4e196056f
ms.sourcegitcommit: 2fbe4932a319af4ebc829f65eb1fb1816ba305d3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/29/2019
ms.locfileid: "73022303"
---
# <a name="new-reference-counting-system-in-xamarinios"></a>Новая система подсчета ссылок в Xamarin. iOS

Xamarin. iOS 9.2.1 представила улучшенную систему подсчета ссылок для всех приложений по умолчанию. Его можно использовать для устранения многих проблем с памятью, которые трудно отвести и исправить в более ранних версиях Xamarin. iOS.

## <a name="enabling-the-new-reference-counting-system"></a>Включение новой системы подсчета ссылок

В Xamarin 9.2.1 новая система подсчета ссылок включена для **всех** приложений по умолчанию.

При разработке существующего приложения можно проверить файл CSPROJ, чтобы убедиться, что все вхождения `MtouchUseRefCounting` имеют значение `true`, как показано ниже:

```xml
<MtouchUseRefCounting>true</MtouchUseRefCounting>
```

Если задано значение `false` приложение не будет использовать новые средства.

### <a name="using-older-versions-of-xamarin"></a>Использование старых версий Xamarin

В Xamarin. iOS 7.2.1 и более поздней версии реализована улучшенная Предварительная версия нашей новой системы подсчета ссылок.

**Classic API:**

Чтобы включить эту новую систему подсчета ссылок, установите флажок **использовать расширение подсчета ссылок** на вкладке **Дополнительно** в **параметрах сборки iOS**проекта, как показано ниже. 

[![](newrefcount-images/image1.png "Enable the new Reference Counting System")](newrefcount-images/image1.png#lightbox)

Обратите внимание, что эти параметры были удалены в более новых версиях Visual Studio для Mac.

 **[Unified API:](~/cross-platform/macios/unified/index.md)**

 Новое расширение подсчета ссылок требуется для Unified API и должно быть включено по умолчанию. В более ранних версиях интегрированной среды разработки это значение может быть не установлено автоматически. возможно, вам придется самостоятельно установить проверку.

> [!IMPORTANT]
> Более ранняя версия этой функции была реализована с момента использования однофункционального 5,2, но была доступна только для **SGen** в экспериментальном режиме. Эта новая улучшенная версия теперь также доступна для сборщика мусора **Boehm** .

Исторически существуют два вида объектов, управляемых с помощью Xamarin. iOS: те, которые были просто оболочкой для собственного объекта (одноранговые объекты), и те, которые расширяют или добавили новые функции (производные объекты) — обычно, сохраняя дополнительное состояние в памяти. Раньше было возможно дополнить одноранговый объект состоянием (например, путем добавления обработчика C# событий), но мы можем разрешить объекту не обращаться к нему и затем собрать данные. Это может привести к сбою позже (например, если среда выполнения цели-C вызывается обратно в управляемый объект).

Новая система автоматически обновляет одноранговые объекты в объектах, управляемых средой выполнения, когда они хранят дополнительные сведения.

Это решает различные сбои, возникшие в следующих ситуациях:

```csharp
class MyTableSource : UITableViewSource {
   public override UITableViewCell GetCell (UITableView tableView, NSIndexPath indexPath) {
        var cell = tableView.DequeueReusableCell ("myId");
        if (cell != null)
                return cell;

        cell = new UITableViewCell (UITableViewCellStyle.Default, "myId");
        var txt = new UITextField ();
        txt.TouchDown += delegate { Console.WriteLine ("...."); };
        cell.ContentView.AddSubview (txt);
        return cell;
   }
}
```

Без расширения счетчика ссылок этот код приведет к сбою, так как `cell` передается, и поэтому его `TouchDown` делегат, который преобразуется в висячий указатель.

Расширение счетчика ссылок гарантирует, что управляемый объект остается активным и предотвращает его сбор, при условии, что собственный объект сохраняется в машинном коде.

Новая система также устраняет необходимость в *большинстве* частных резервных полей, используемых в привязках, что является подходом по умолчанию для сохранения экземпляра в активном состоянии. Управляемый компоновщик достаточно интеллектуально, чтобы удалить из приложений все *ненужные* поля, используя новое расширение счетчика ссылок.

Это означает, что каждый экземпляр управляемого объекта потребляет меньше памяти, чем раньше. Она также решает проблему, связанную с тем, что некоторые резервные поля содержат ссылки, которые больше не требовались исполняющей средой цели-C, что затрудняет освобождение памяти.
