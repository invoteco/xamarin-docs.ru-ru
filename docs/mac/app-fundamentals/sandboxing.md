---
title: Изолирование приложения Xamarin. Mac
description: В этой статье рассматривается изолированное приложение Xamarin. Mac для выпуска в App Store. В нем рассматриваются все элементы, которые переходят в "песочницу", такие как каталоги контейнеров, права, определяемые пользователем разрешения, разделение прав и принудительное применение ядра.
ms.prod: xamarin
ms.assetid: 06A2CA8D-1E46-410F-8C31-00EA36F0735D
ms.technology: xamarin-mac
author: davidortinau
ms.author: daortin
ms.date: 03/14/2017
ms.openlocfilehash: 02059c43d26c2e685abd685231fe5faf3d7a6bfe
ms.sourcegitcommit: 2fbe4932a319af4ebc829f65eb1fb1816ba305d3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/29/2019
ms.locfileid: "73030111"
---
# <a name="sandboxing-a-xamarinmac-app"></a>Изолирование приложения Xamarin. Mac

_В этой статье рассматривается изолированное приложение Xamarin. Mac для выпуска в App Store. В нем рассматриваются все элементы, которые переходят в "песочницу", такие как каталоги контейнеров, права, определяемые пользователем разрешения, разделение прав и принудительное применение ядра._

## <a name="overview"></a>Обзор

При работе с C# и .NET в приложении Xamarin. Mac у вас есть те же возможности, что и при работе с заданиями «цель-C» или «SWIFT».

[![Пример выполняющегося приложения](sandboxing-images/intro01.png "Пример выполняющегося приложения")](sandboxing-images/intro01-large.png#lightbox)

В этой статье рассматриваются основные принципы работы с песочницей в приложении Xamarin. Mac и все элементы, которые переходят в "песочницу": каталоги контейнеров, права, определяемые пользователем разрешения, разделение прав и принудительное применение ядра. Мы настоятельно рекомендуем сначала ознакомиться со статьей [Hello, Mac](~/mac/get-started/hello-mac.md) , в частности [Знакомство с Xcode и Interface Builder](~/mac/get-started/hello-mac.md#introduction-to-xcode-and-interface-builder) , а также с разделом "возможности [и действия](~/mac/get-started/hello-mac.md#outlets-and-actions) ", так как в нем рассматриваются основные понятия и методы, которые мы будем использовать в Эта статья.

Возможно, вы захотите ознакомиться с [ C# представлением классов и методов для цели-C](~/mac/internals/how-it-works.md) в документе о внутренних компонентах [Xamarin. Mac](~/mac/internals/how-it-works.md) , а также объясняются `Register` и `Export` атрибуты, используемые для подключения C# классов к цели-C. объекты и элементы пользовательского интерфейса.

## <a name="about-the-app-sandbox"></a>Сведения о песочнице приложения

Песочница приложения обеспечивает надежную защиту от повреждений, которые могут быть вызваны вредоносным приложением, выполняемым на компьютере Mac, ограничивая доступ приложения к системным ресурсам.

Неизолированное приложение имеет полные права пользователя, запускающего приложение, и может получать доступ к любому пользователю или выполнять какие-либо действия. Если приложение содержит бреши в системе безопасности (или любую используемую платформу), злоумышленник может воспользоваться этими слабыми местами и использовать приложение для управления компьютером Mac, на котором он работает.

Ограничивая доступ к ресурсам отдельно для каждого приложения, изолированное приложение обеспечивает линию защиты от кражи, повреждения или вредоносных целей в рамках приложения, работающего на компьютере пользователя.

Песочница приложения — это технология управления доступом, встроенная в macOS (применяется на уровне ядра), которая предоставляет стратегию двойная:

1. Песочница приложения позволяет разработчику описать, _как_ приложение будет взаимодействовать с операционной системой, и, таким образом, ему предоставляются только права доступа, необходимые для того, чтобы задача была выполнена.
2. Песочница приложения позволяет пользователю легко предоставлять дополнительный доступ к системе с помощью диалоговых окон Открытие и сохранение, операции перетаскивания и другие, общие пользовательские взаимодействия.

### <a name="preparing-to-implement-the-app-sandbox"></a>Подготовка к реализации песочницы приложения

Элементы песочницы приложения, которые будут подробно обсуждаться в статье, выглядят следующим образом.

- Каталоги контейнеров
- Прав
- Определяемые пользователем разрешения
- Разделение привилегий
- Принудительное применение ядра

После ознакомления с этими сведениями вы сможете создать план для внедрения изолированной среды приложения в приложение Xamarin. Mac.

Во-первых, необходимо определить, является ли ваше приложение хорошим кандидатом для "песочницы" (большинство приложений —). Далее необходимо разрешить любые несовместимости API и определить, какие элементы изолированной среды приложения будут необходимы. Наконец, воспользуйтесь разделением привилегий, чтобы повысить уровень защиты приложения.

При внедрении песочницы приложения некоторые расположения файловой системы, используемые приложением, будут отличаться. В частности, приложение будет иметь каталог контейнера, который будет использоваться для файлов поддержки приложений, баз данных, кэшей и других файлов, не являющихся документами пользователя. Как macOS, так и Xcode обеспечивают поддержку переноса файлов этих типов из их устаревших расположений в контейнер.

## <a name="sandboxing-quick-start"></a>Быстрый запуск "песочницы"

В этом разделе мы создадим простое приложение Xamarin. Mac, которое использует веб-представление (для которого требуется сетевое подключение с ограниченным использованием песочницы, если специально не запрошено) в качестве примера начала работы с песочницей приложения.

Мы проверим, что приложение действительно является изолированным, и узнаете, как устранять неполадки и устранять распространенные ошибки песочницы приложения.

### <a name="creating-the-xamarinmac-project"></a>Создание проекта Xamarin. Mac

Для создания нашего примера проекта выполните следующие действия.

1. Запустите Visual Studio для Mac и щелкните **новое решение.** .
2. В диалоговом окне **Новый проект** выберите **Mac**  > **приложение**  > **приложение Cocoa**:

    [![Создание нового приложения Cocoa](sandboxing-images/sample01.png "Создание нового приложения Cocoa")](sandboxing-images/sample01-large.png#lightbox)
3. Нажмите кнопку " **Далее** ", введите `MacSandbox` в качестве имени проекта и нажмите кнопку " **создать** ":

    [![Ввод имени приложения](sandboxing-images/sample02.png "Ввод имени приложения")](sandboxing-images/sample02-large.png#lightbox)
4. В **панель решения**дважды щелкните файл **Main. Storyboard** , чтобы открыть его для редактирования в Xcode:

    [![Изменение основной раскадровки](sandboxing-images/sample03.png "Изменение основной раскадровки")](sandboxing-images/sample03-large.png#lightbox)
5. Перетащите **веб-представление** в окно, измените его размер, чтобы заполнить область содержимого, и задайте для него увеличение и уменьшение с помощью окна:

    [![Добавление веб-представления](sandboxing-images/sample04.png "Добавление веб-представления")](sandboxing-images/sample04-large.png#lightbox)
6. Создайте выход для веб-представления с именем `webView`:

    [![Создание новой розетки](sandboxing-images/sample05.png "Создание новой розетки")](sandboxing-images/sample05-large.png#lightbox)
7. Вернитесь в Visual Studio для Mac и дважды щелкните файл **ViewController.CS** на **панель решения** , чтобы открыть его для редактирования.
8. Добавьте следующую инструкцию using: `using WebKit;`
9. Сделайте метод `ViewDidLoad` выглядеть следующим образом:

    ```csharp
    public override void AwakeFromNib ()
    {
        base.AwakeFromNib ();
        webView.MainFrame.LoadRequest(new NSUrlRequest(new NSUrl("http://www.apple.com")));
    }
    ```

10. Сохраните изменения.

Запустите приложение и убедитесь, что веб-сайт Apple отображается в окне следующим образом:

[![Отображение примера запуска приложения](sandboxing-images/sample06.png "Отображение примера запуска приложения")](sandboxing-images/sample06-large.png#lightbox)

<a name="Signing_and_Provisioning_the_App" />

### <a name="signing-and-provisioning-the-app"></a>Подписывание и подготовка приложения

Прежде чем мы можем включить песочницу приложения, сначала необходимо предоставить и подписать приложение Xamarin. Mac.

Выполните следующие действия.

1. Войдите на портал разработчика Apple:

    [![Вход на портал разработчика Apple](sandboxing-images/sign01.png "Вход на портал разработчика Apple")](sandboxing-images/sign01-large.png#lightbox)
2. Выберите **сертификаты, идентификаторы & профили**:

    [![Выбор сертификатов, идентификаторов & профилей](sandboxing-images/sign02.png "Выбор сертификатов, идентификаторов & профилей")](sandboxing-images/sign02-large.png#lightbox)
3. В разделе **приложения Mac**выберите **идентификаторы**:

    [![Выбор идентификаторов](sandboxing-images/sign03.png "Выбор идентификаторов")](sandboxing-images/sign03-large.png#lightbox)
4. Создайте новый идентификатор для приложения:

    [![Создание нового идентификатора приложения](sandboxing-images/sign04.png "Создание нового идентификатора приложения")](sandboxing-images/sign04-large.png#lightbox)
5. В разделе **профили подготовки**выберите **Разработка**.

    [![Выбор разработки](sandboxing-images/sign05.png "Выбор разработки")](sandboxing-images/sign05-large.png#lightbox)
6. Создайте новый профиль и выберите **Разработка приложений для Mac**:

    [![Создание нового профиля](sandboxing-images/sign06.png "Создание нового профиля")](sandboxing-images/sign06-large.png#lightbox)
7. Выберите созданный ранее идентификатор приложения:

    [![Выбор идентификатора приложения](sandboxing-images/sign07.png "Выбор идентификатора приложения")](sandboxing-images/sign07-large.png#lightbox)
8. Выберите разработчиков для этого профиля:

    [![Добавление разработчиков](sandboxing-images/sign08.png "Добавление разработчиков")](sandboxing-images/sign08-large.png#lightbox)
9. Выберите компьютеры для этого профиля:

    [![Выбор разрешенных компьютеров](sandboxing-images/sign09.png "Выбор разрешенных компьютеров")](sandboxing-images/sign09-large.png#lightbox)
10. Укажите имя профиля:

    [![Присвоение имени профилю](sandboxing-images/sign10.png "Присвоение имени профилю")](sandboxing-images/sign10-large.png#lightbox)
11. Нажмите кнопку **done (Готово** ).

> [!IMPORTANT]
> В некоторых случаях может потребоваться скачать новый профиль подготовки с портала разработчика Apple и дважды щелкнуть его, чтобы установить. Чтобы получить доступ к новому профилю, может также потребоваться повторный запуск и перезапуск Visual Studio для Mac.

Далее необходимо загрузить новый идентификатор приложения и профиль на компьютере разработки. Давайте выполним следующие действия.

1. Запустите Xcode и выберите в меню **Xcode** пункт **предпочтения** .

    ![Изменение учетных записей в Xcode](sandboxing-images/sign11.png "Изменение учетных записей в Xcode")
2. Нажмите кнопку **Просмотреть подробности...** .

    ![Нажатие кнопки «Просмотреть сведения»](sandboxing-images/sign12.png "Нажатие кнопки «Просмотреть сведения»")
3. Нажмите кнопку " **Обновить** " (в нижнем левом углу).
4. Нажмите кнопку **Готово** .

Далее необходимо выбрать новый идентификатор приложения и профиль подготовки в проекте Xamarin. Mac. Давайте выполним следующие действия.

1. В **панель решения**дважды щелкните файл **info. plist** , чтобы открыть его для редактирования.
2. Убедитесь, что **идентификатор пакета** соответствует нашему созданному нами идентификатору приложения (например: `com.appracatappra.MacSandbox`):

    [![Изменение идентификатора пакета](sandboxing-images/sign13.png "Изменение идентификатора пакета")](sandboxing-images/sign13-large.png#lightbox)
3. Затем дважды щелкните файл прав **. plist** и убедитесь, что наш **банк данных типа "ключ — значение** " и все **КОНТЕЙНЕРы iCloud** соответствуют нашему идентификатору приложения, созданному ранее (например: `com.appracatappra.MacSandbox`):

    [![Изменение файла прав. plist](sandboxing-images/sign17.png "Изменение файла прав. plist")](sandboxing-images/sign17-large.png#lightbox)
4. Сохраните изменения.
5. В **панель решения**дважды щелкните файл проекта, чтобы открыть его параметры для редактирования.

    ![Едитигн параметры решения](sandboxing-images/sign14.png "Едитигн параметры решения")
6. Выберите **Подписывание Mac**, а затем установите флажок **подписать пакет приложений** и **Подписывание пакета установщика**. В разделе **профиль подготовки**выберите тот, который мы создали ранее.

    ![Настройка профиля подготовки](sandboxing-images/sign15.png "Настройка профиля подготовки")
7. Нажмите кнопку **done (Готово** ).

> [!IMPORTANT]
> Возможно, потребуется выйти и перезапустить Visual Studio для Mac, чтобы узнать новый идентификатор приложения и профиль подготовки, который был установлен с помощью Xcode.

#### <a name="troubleshooting-provisioning-issues"></a>Устранение неполадок при подготовке

На этом этапе следует попытаться запустить приложение и убедиться, что все подписано и правильно подготовлено. Если приложение по-прежнему выполняется как раньше, все будет хорошим. В случае сбоя может появиться диалоговое окно следующего вида:

[![Пример диалогового окна проблемы подготовки](sandboxing-images/sign16.png "Пример диалогового окна проблемы подготовки")](sandboxing-images/sign16-large.png#lightbox)

Ниже приведены наиболее распространенные причины проблем подготовки и подписывания.

- Идентификатор набора приложений не соответствует ИДЕНТИФИКАТОРу приложения выбранного профиля.
- Идентификатор разработчика не соответствует ИДЕНТИФИКАТОРу разработчика выбранного профиля.
- UUID тестируемого Mac-адреса не зарегистрирован как часть выбранного профиля.

В случае проблемы устраните проблему на портале разработчика Apple, обновите профили в Xcode и выполните чистую сборку в Visual Studio для Mac.

### <a name="enable-the-app-sandbox"></a>Включение песочницы приложения

Чтобы включить песочницу приложения, установите флажок в параметрах проектов. Выполните следующие действия:

1. В **панель решения**дважды щелкните файл прав **. plist** , чтобы открыть его для редактирования.
2. Установите флажок **включить** права и **включить изолированные приложения**:

    [![Изменение прав и включение "песочницы"](sandboxing-images/sign17.png "Изменение прав и включение "песочницы"")](sandboxing-images/sign17-large.png#lightbox)
3. Сохраните изменения.

На этом этапе вы включили песочницу приложения, но не указали необходимый доступ к сети для веб-представления. Если запустить приложение сейчас, вы получите пустое окно:

[![Отображение заблокированного веб-доступа](sandboxing-images/sample08.png "Отображение заблокированного веб-доступа")](sandboxing-images/sample08-large.png#lightbox)

### <a name="verifying-that-the-app-is-sandboxed"></a>Проверка того, что приложение изолировано

Помимо поведения блокировки ресурсов существует три основных способа определить, успешно ли была выполнена изолированная среда приложения Xamarin. Mac:

1. В окне поиска проверьте содержимое папки `~/Library/Containers/`. Если приложение является изолированным, будет существовать папка с именем, аналогичным идентификатору пакета приложения (пример: `com.appracatappra.MacSandbox`):

    [![Открытие пакета приложения](sandboxing-images/sample09.png "Открытие пакета приложения")](sandboxing-images/sample09-large.png#lightbox)
2. Система видит приложение как изолированное в мониторе активности:
    - Запустите монитор активности (в разделе `/Applications/Utilities`).
    - Выберите **просмотр**  > **столбцы** и убедитесь, что выбран пункт меню **песочницы** .
    - Убедитесь, что столбец "песочницы" считывает `Yes` для вашего приложения:

    [![Проверка приложения в мониторе активности](sandboxing-images/sample10.png "Проверка приложения в мониторе активности")](sandboxing-images/sample10-large.png#lightbox)
3. Убедитесь, что двоичный файл приложения является изолированным:
    - Запустите приложение терминала.
    - Перейдите в каталог Applications `bin`.
    - Выполните следующую команду: `codesign -dvvv --entitlements :- executable_path` (где `executable_path` — путь к приложению):

    [![Проверка приложения в командной строке](sandboxing-images/sample11.png "Проверка приложения в командной строке")](sandboxing-images/sample11-large.png#lightbox)

### <a name="debugging-a-sandboxed-app"></a>Отладка изолированного приложения

Отладчик подключается к приложениям Xamarin. Mac по протоколу TCP. Это означает, что по умолчанию при включении "песочницы" не удается подключиться к приложению, поэтому при попытке запустить приложение без соответствующих разрешений вы получите сообщение об ошибке *"не удается подключиться к отладчику".* .

[![Настройка необходимых параметров](sandboxing-images/debug01.png "Настройка необходимых параметров")](sandboxing-images/debug01-large.png#lightbox)

Разрешение **Разрешить исходящие сетевые подключения (клиент)** является обязательным для отладчика, что позволяет выполнять отладку в обычном режиме. Так как вы не можете выполнить отладку без него, мы обновили `CompileEntitlements` целевой объект для `msbuild`, чтобы автоматически добавить соответствующее разрешение для всех приложений, которые изолированы только для отладочных сборок. Сборки выпуска должны использовать права, указанные в файле прав, без изменений.

### <a name="resolving-an-app-sandbox-violation"></a>Устранение нарушения песочницы приложения

Нарушение песочницы приложения возникает, если изолированное приложение Xamarin. Mac пытается получить доступ к ресурсу, который явно не разрешен. Например, наше веб-представление больше не может отображать веб-сайт Apple.

Наиболее распространенный источник нарушений изолированной среды приложения возникает, когда параметры прав, указанные в Visual Studio для Mac, не соответствуют требованиям приложения. Опять же, вернемся к нашему примеру, отсутствующие права сетевого подключения, которые сохраняют работу веб-представления.

#### <a name="discovering-app-sandbox-violations"></a>Обнаружение нарушений изолированной среды приложения

Если вы считаете, что в приложении Xamarin. Mac происходит нарушение песочницы приложения, самый быстрый способ обнаружить эту неполадку — использовать **консольное** приложение.

Выполните следующие действия:

1. Скомпилируйте рассматриваемое приложение и запустите его из Visual Studio для Mac.
2. Откройте **консольное** приложение (из `/Applications/Utilties/`).
3. Выберите **все сообщения** на боковой панели и введите `sandbox` в поле поиска:

    [![Пример проблемы с песочницей в консоли](sandboxing-images/resolve01.png "Пример проблемы с песочницей в консоли")](sandboxing-images/resolve01-large.png#lightbox)

Для нашего примера приложения, приведенного выше, можно увидеть, что кернинг блокирует `network-outbound`ный трафик из-за песочницы приложения, так как мы не запрашивали это право.

#### <a name="fixing-app-sandbox-violations-with-entitlements"></a>Исправление нарушений песочницы приложения с помощью прав

Теперь, когда мы рассмотрели, как найти нарушения изолированности приложений, давайте посмотрим, как их можно решить, изменив свои права приложения.

Выполните следующие действия:

1. В **панель решения**дважды щелкните файл прав **. plist** , чтобы открыть его для редактирования.
2. **В разделе "** права" установите флажок **Разрешить исходящие сетевые подключения (клиент)** :

    [![Изменение прав](sandboxing-images/sign17.png "Изменение прав")](sandboxing-images/sign17-large.png#lightbox)
3. Сохраните изменения в приложении.

Если мы делаем приведенный выше пример приложения, выполните сборку и запустите его, после чего веб-содержимое отобразится правильно.

## <a name="the-app-sandbox-in-depth"></a>Подробные сведения о песочнице приложения

Механизмы управления доступом, предоставляемые песочницей приложения, просты и понятны. Тем не менее, в соответствии с требованиями приложения, изолированная среда приложения будет использоваться каждым приложением уникальным образом.

Учитывая наилучшие усилия по защите приложения Xamarin. Mac от использования вредоносным кодом, в приложении (или одной из используемых библиотек или платформ) должна быть только одна уязвимость, чтобы получить контроль над взаимодействием приложения с системой.

Изолированная среда приложения была разработана таким образом, чтобы предотвратить перенаправление (или ограничить ущерб, который она может вызвать), позволяя указать предполагаемое взаимодействие приложения с системой. Система предоставит доступ только к ресурсу, который требуется вашему приложению для работы, и ничего больше.

При проектировании для песочницы приложения вы разрабатываете для наихудшего сценария. Если приложение становится скомпрометировано вредоносным кодом, оно ограничено доступом только к файлам и ресурсам в песочнице приложения.

### <a name="entitlements-and-system-resource-access"></a>Права доступа и доступ к ресурсам системы

Как было показано выше, приложение Xamarin. Mac, которое не было изолировано, получает полные права и доступ пользователя, запустившего приложение. При компрометации вредоносного кода незащищенное приложение может действовать как агент для злонамеренного поведения, используя широкий спектр возможных последствий для причинения вреда.

Включив "песочницу приложения", вы удалите все права, кроме минимального набора привилегий, которые вы затем включите повторно в соответствии с назначением приложения Xamarin. Mac.

Чтобы изменить ресурсы песочницы приложения, изменив его файл прав **. plist** и установив или выбрав права, необходимые в раскрывающихся списках редакторы:

[![Изменение прав](sandboxing-images/sign17.png "Изменение прав")](sandboxing-images/sign17-large.png#lightbox)

### <a name="container-directories-and-file-system-access"></a>Каталоги контейнеров и доступ к файловой системе

Когда приложение Xamarin. Mac принимает песочницу приложения, оно имеет доступ к следующим расположениям:

- **Каталог контейнера приложения** — при первом запуске ОС создает специальный _Каталог контейнера_ , в котором все его ресурсы находятся, только к которым он имеет доступ. Приложение будет иметь полный доступ для чтения и записи к этому каталогу.
- **Каталоги контейнеров группы приложений** . приложению можно предоставить доступ к одному или нескольким _контейнерам групп_ , которые являются общими для приложений в одной группе.
- **Пользовательские файлы** — приложение автоматически получает доступ к файлам, которые явным образом открыты или перетаскиваются в приложение пользователем.
- **Связанные элементы** — с соответствующими назначениями приложение может иметь доступ к файлу с тем же именем, но с другим расширением. Например, документ, сохраненный как файл `.txt` и `.pdf`.
- **Временные каталоги, каталоги средств командной строки и определенные** общедоступные расположения — приложение имеет разную степень доступа к файлам в других хорошо определенных расположениях, заданных системой.

#### <a name="the-app-container-directory"></a>Каталог контейнера приложения

Каталог контейнера приложения Xamarin. Mac имеет следующие характеристики.

- Он находится в скрытом расположении в домашнем каталоге пользователя (обычно `~Library/Containers`), и доступ к нему можно получить с помощью функции `NSHomeDirectory` (см. ниже) в приложении. Так как он находится в домашнем каталоге, каждый пользователь получит собственный контейнер для приложения.
- Приложение имеет неограниченный доступ на чтение и запись к каталогу контейнера, а также ко всем вложенным каталогам и файлам в нем.
- Большинство API-интерфейсов поиска пути macOS относятся к контейнеру приложения. Например, контейнер будет иметь собственную **библиотеку** (доступ к которой осуществляется через `NSLibraryDirectory`), **поддержку приложений** и подкаталоги **предпочтений** .
- macOS устанавливает и обеспечивает подключение между приложением и его контейнером с помощью подписывания кода. Даже если другое приложение пытается подменить приложение с помощью его **идентификатора пакета**, он не сможет получить доступ к контейнеру из-за подписывания кода.
- Контейнер не предназначен для файлов, созданных пользователем. Вместо этого он предназначен для файлов, используемых приложением, таких как базы данных, кэши или другие данные конкретного типа.
- Для _Shoebox_ типов приложений (например, для приложения Apple Photo) содержимое пользователя перейдет в контейнер.

> [!IMPORTANT]
> К сожалению, Xamarin. Mac еще не имеет 100% покрытия API (в отличие от Xamarin. iOS), в результате `NSHomeDirectory` API не был сопоставлен в текущей версии Xamarin. Mac.

В качестве временного решения можно использовать следующий код:

```csharp
[System.Runtime.InteropServices.DllImport("/System/Library/Frameworks/Foundation.framework/Foundation")]
public static extern IntPtr NSHomeDirectory();

public static string ContainerDirectory {
    get {
        return ((NSString)ObjCRuntime.Runtime.GetNSObject(NSHomeDirectory())).ToString ();
        }
}
```

#### <a name="the-app-group-container-directory"></a>Каталог контейнера группы приложений

Начиная с Mac macOS 10.7.5 (и более поздних версий), приложение может использовать `com.apple.security.application-groups` назначения для доступа к общему контейнеру, который является общим для всех приложений в группе. Этот общий контейнер можно использовать для содержимого, не предназначенного для пользователей, например для базы данных или других типов файлов поддержки (например, кэшей).

Контейнеры групп автоматически добавляются в контейнер песочницы каждого приложения (если они являются частью группы) и хранятся в `~/Library/Group Containers/<application-group-id>`. Идентификатор группы _должен_ начинаться с идентификатора команды разработки и точки, например:

```plist
<team-id>.com.company.<group-name>
```

Дополнительные сведения см. в статье [Добавление приложения Apple в группу приложений](https://developer.apple.com/library/prerelease/mac/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/EnablingAppSandbox.html#//apple_ref/doc/uid/TP40011195-CH4-SW19) в [справочнике по ключам](https://developer.apple.com/library/prerelease/mac/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/AboutEntitlements.html#//apple_ref/doc/uid/TP40011195)прав.

#### <a name="powerbox-and-file-system-access-outside-of-the-app-container"></a>Повербокс и доступ к файловой системе за пределами контейнера приложения

Изолированное приложение Xamarin. Mac может обращаться к расположениям файловой системы за пределами контейнера следующими способами.

- В определенном направлении пользователя (с помощью диалоговых окон открытия и сохранения или других методов, таких как перетаскивание).
- С помощью прав для конкретных расположений файловой системы (например, `/bin` или `/usr/lib`).
- Если расположение файловой системы находится в определенных каталогах, доступных для чтения (например, совместное использование).

_Повербокс_ — это технология безопасности macOS, которая взаимодействует с пользователем для расширения прав доступа к файлам в изолированном приложении Xamarin. Mac. Повербокс не имеет API, но активируется прозрачно, когда приложение вызывает `NSOpenPanel` или `NSSavePanel`. Доступ к повербокс включается с помощью прав, заданных для приложения Xamarin. Mac.

Когда в изолированном приложении отображается диалоговое окно открытия или сохранения, окно представляется Повербокс (и не AppKit) и поэтому имеет доступ к любому файлу или каталогу, к которому у пользователя есть доступ.

Когда пользователь выбирает файл или каталог в диалоговом окне открытия или сохранения (или перемещается на значок приложения), Повербокс добавляет связанный путь в песочницу приложения.

Кроме того, система автоматически разрешает следующее в изолированном приложении:

- Соединение с системным методом ввода.
- Вызовите службы, выбранные пользователем, из меню " **службы** " (только для служб, помеченных как _надежные для приложений песочницы_ поставщиком услуг).
- Открыть файлы выберите пользователя в меню **Открыть последние** .
- Используйте копирование & вставки между другими приложениями.
- Чтение файлов из следующих расположений, доступных для чтения:
  - `/bin`
  - `/sbin`
  - `/usr/bin`
  - `/usr/lib`
  - `/usr/sbin`
  - `/usr/share`
  - `/System`
- Чтение и запись файлов в каталогах, созданных `NSTemporaryDirectory`.

По умолчанию файлы, открытые или сохраненные в изолированном приложении Xamarin. Mac, остаются доступными до завершения работы приложения (если только файл не был открыт при закрытии приложения). Открытые файлы будут автоматически восстановлены в песочнице приложения с помощью функции macOS Resume при следующем запуске приложения.

Чтобы обеспечить сохранение файлов, расположенных за пределами контейнера приложения Xamarin. Mac, используйте закладки с областью действия безопасности (см. ниже).

#### <a name="related-items"></a>Связанные элементы

Песочница приложения позволяет приложению получить доступ к связанным элементам, имеющим одно и то же имя файла, но с разными расширениями. Эта функция состоит из двух частей: a) списка связанных расширений в файле `Info.plst` файла приложения, b), чтобы сообщить песочнице о том, что приложение будет выполнять с этими файлами.

Существует два сценария, в которых это имеет смысл:

1. Приложение должно иметь возможность сохранить другую версию файла (с новым расширением). Например, экспорт файла `.txt` в файл `.pdf`. Для решения этой ситуации необходимо использовать `NSFileCoordinator` для доступа к файлу. Сначала нужно вызвать метод `WillMove(fromURL, toURL)`, переместить файл в новое расширение, а затем вызвать `ItemMoved(fromURL, toURL)`.
2. Приложению необходимо открыть основной файл с одним расширением и несколькими вспомогательными файлами с разными расширениями. Например, фильм и файл подзаголовка. Используйте `NSFilePresenter`, чтобы получить доступ к вторичному файлу. Укажите основной файл для свойства `PrimaryPresentedItemURL` и вторичного файла в свойстве `PresentedItemURL`. При открытии главного файла вызовите метод `AddFilePresenter` класса `NSFileCoordinator`, чтобы зарегистрировать вторичный файл.

В обоих сценариях файл **info. plist** приложения должен объявлять типы документов, которые может открыть приложение. Для любого типа файлов добавьте `NSIsRelatedItemType` (со значением `YES`) в запись в массиве `CFBundleDocumentTypes`.

#### <a name="open-and-save-dialog-behavior-with-sandboxed-apps"></a>Открытие и сохранение поведения диалогового окна с помощью изолированных приложений

Следующие ограничения помещаются на `NSOpenPanel` и `NSSavePanel` при их вызове из изолированного приложения Xamarin. Mac:

- Невозможно программно вызвать кнопку **ОК** .
- Невозможно программно изменить выбор пользователя в `NSOpenSavePanelDelegate`.

Кроме того, применяются следующие изменения наследования:

- `NSOpenPanel` - **неизолированных приложений** `NSSavePanel``NSPanel``NSWindow``NSResponder``NSObject``NSOpenPanel``NSSavePanel``NSObject``NSOpenPanel``NSSavePanel`

### <a name="security-scoped-bookmarks-and-persistent-resource-access"></a>Закладки с областью действия безопасности и постоянный доступ к ресурсам

Как упоминалось выше, изолированное приложение Xamarin. Mac может обращаться к файлу или ресурсу за пределами своего контейнера путем прямого взаимодействия с пользователем (предоставленного Повербокс). Однако доступ к этим ресурсам не сохраняется автоматически при запуске приложения или при перезапуске системы.

С помощью _закладок с областью действия безопасности_изолированное приложение Xamarin. Mac может сохранить намерение пользователя и обеспечить доступ к заданным ресурсам после перезапуска приложения.

#### <a name="security-scoped-bookmark-types"></a>Типы закладок с областью действия безопасности

При работе с закладками уровня безопасности и постоянным доступом к ресурсам существует два варианта использования систине:

- **Закладка с областью действия приложения обеспечивает постоянный доступ к указанному пользователем файлу или папке.**

    Например, если изолированное приложение Xamarin. Mac позволяет использовать для открытия внешнего документа для редактирования (с помощью `NSOpenPanel`), приложение может создать закладку с областью действия приложения, чтобы она снова могла получить доступ к тому же файлу в будущем.
- **Закладка с областью действия документа предоставляет конкретный документ для постоянного доступа к вложенному файлу.**

Например, приложение для редактирования видео, которое создает файл проекта с доступом к отдельным изображениям, видеоклипы и звуковые файлы, которые впоследствии будут объединены в один фильм.

Когда пользователь импортирует файл ресурсов в проект (с помощью `NSOpenPanel`), приложение создает закладку области документа для элемента, хранящегося в проекте, чтобы файл всегда был доступен для приложения.

Закладка, область действия которого зависит от документа, может быть разрешена любым приложением, которое может открывать данные закладки и сам документ. Это обеспечивает поддержку переносимости, позволяя пользователю отправить файлы проекта другому пользователю, и все эти закладки также должны работать.

> [!IMPORTANT]
> Закладка с областью действия документа может указывать _только_ на один файл, а не на папку, и этот файл не может находиться в расположении, используемом системой (например, `/private` или `/Library`).

#### <a name="using-security-scoped-bookmarks"></a>Использование закладок с областью действия безопасности

При использовании любой из типов закладок с областью действия безопасности необходимо выполнить следующие действия.

1. **Настройте соответствующие права в приложении Xamarin. Mac, которое должно использовать закладки с областью действия безопасности** . для закладок с областью действия приложения задайте для `com.apple.security.files.bookmarks.app-scope` ключ прав доступа значение `true`. Для закладок с областью действия документа задайте для параметра `com.apple.security.files.bookmarks.document-scope` право на `true`.
2. **Создайте закладку с областью действия безопасности** . это можно сделать для любого файла или папки, к которым пользователь предоставил доступ (через `NSOpenPanel` например), что приложению потребуется постоянный доступ к. Чтобы создать закладку, используйте метод `public virtual NSData CreateBookmarkData (NSUrlBookmarkCreationOptions options, string[] resourceValues, NSUrl relativeUrl, out NSError error)` класса `NSUrl`.
3. **Разрешение закладки с областью безопасности** . когда приложению требуется снова получить доступ к ресурсу (например, после перезапуска), необходимо разрешить закладку в URL-адрес с областью действия безопасности. Для разрешения закладки используйте метод `public static NSUrl FromBookmarkData (NSData data, NSUrlBookmarkResolutionOptions options, NSUrl relativeToUrl, out bool isStale, out NSError error)` класса `NSUrl`.
4. **Явно уведомлять систему, к которой требуется доступ к файлу, из URL-адреса с областью действия безопасности** . Этот шаг необходимо выполнить сразу после получения URL-адреса уровня безопасности выше или, если позже потребуется восстановить доступ к ресурсу после повышена попытка доступа к нему. Вызовите метод `StartAccessingSecurityScopedResource ()` класса `NSUrl`, чтобы начать доступ к URL-адресу с областью действия безопасности.
5. **Явно уведомлять систему о том, что вы закрыли доступ к файлу из URL-адреса с областью действия безопасности** . как можно скорее, следует информировать систему, когда приложению больше не требуется доступ к файлу (например, если пользователь закрывает его). Вызовите метод `StopAccessingSecurityScopedResource ()` класса `NSUrl`, чтобы запретить доступ к URL-адресу с областью действия безопасности.

После получения доступа к ресурсу необходимо снова вернуться к шагу 4, чтобы снова установить доступ. Если приложение Xamarin. Mac перезапущено, необходимо вернуться к шагу 3 и повторно разрешить закладку.

> [!IMPORTANT]
> Если не удалось освободить доступ к ресурсам URL-адресов с областью действия безопасности, приложение Xamarin. Mac будет утечкой ресурсов ядра. В результате приложение больше не сможет добавлять расположения файловой системы в контейнер, пока он не будет перезапущен.

### <a name="the-app-sandbox-and-code-signing"></a>Изолированная среда приложения и подписывание кода

После включения "песочницы" приложения и включения конкретных требований для приложения Xamarin. Mac (с помощью прав) необходимо подписать проект для вступления в силу "песочницы". Необходимо выполнить подписывание кода, так как права, необходимые для изолирования приложений, связаны с подписью приложения.

macOS принудительно устанавливает связь между контейнером приложения и его сигнатурой кода, таким образом, другие приложения не могут получить доступ к этому контейнеру, даже если он подмена идентификатора пакета приложений. Этот механизм работает следующим образом.

1. Когда система создает контейнер приложения, она устанавливает _список управления доступом_ (ACL) для этого контейнера. Начальная запись контроля доступа в списке содержит _заданное требование_ приложения (Dr), которое описывает, как можно распознать будущие версии приложения (когда оно было обновлено).
2. При каждом запуске приложения с одним и тем же ИДЕНТИФИКАТОРом пакета система проверяет, соответствует ли сигнатура кода приложения заданным требованиям, указанным в одной из записей в ACL контейнера. Если система не находит совпадения, это не позволяет приложению запуститься.

Подписывание кода работает следующим образом:

1. Перед созданием проекта Xamarin. Mac получите сертификат разработки, сертификат распространения и сертификат идентификатора разработчика на портале разработчика Apple.
2. Когда Mac App Store распространяет приложение Xamarin. Mac, оно подписывается с помощью сигнатуры кода Apple.

При тестировании и отладке вы будете использовать версию приложения Xamarin. Mac, которую вы подписали (которая будет использоваться для создания контейнера приложения). Позже, если вы хотите протестировать или установить версию из Apple App Store, она будет подписана с подписью Apple и не будет запущена (так как она не имеет той же подписи кода, что и исходный контейнер приложения). В этом случае вы получите отчет о сбоях следующего вида:

```csharp
Exception Type:  EXC_BAD_INSTRUCTION (SIGILL)
```

Чтобы устранить эту проблему, необходимо настроить запись ACL, чтобы она указывала на подписанную версию приложения Apple.

Дополнительные сведения о создании и скачивании профилей подготовки, необходимых для "песочницы", см. в разделе [Подписывание и подготовка приложения](#Signing_and_Provisioning_the_App) выше.

#### <a name="adjusting-the-acl-entry"></a>Настройка записи ACL

Чтобы разрешить запуск приложения Xamarin. Mac с подпиской Apple, выполните следующие действия.

1. Откройте приложение Terminal (в `/Applications/Utilities`).
2. Откройте окно Finder для версии приложения Xamarin. Mac, подписанного Apple.
3. Введите `asctl container acl add -file` в окне терминала.
4. Перетащите значок приложения Xamarin. Mac из окна Finder и поместите его в окно терминала.
5. Полный путь к файлу будет добавлен в команду терминала.
6. Нажмите клавишу **Ввод** , чтобы выполнить команду.

Список ACL контейнера теперь содержит назначенные требования к коду для обеих версий приложения Xamarin. Mac и macOS теперь позволяет запускать любую из версий.

#### <a name="display-a-list-of-acl-code-requirements"></a>Отображение списка требований к коду ACL

Список требований к коду в ACL контейнера можно просмотреть, выполнив следующие действия.

1. Откройте приложение Terminal (в `/Applications/Utilities`).
2. Введите `asctl container acl list -bundle <container-name>`.
3. Нажмите клавишу **Ввод** , чтобы выполнить команду.

`<container-name>` обычно является идентификатором пакета для приложения Xamarin. Mac.

## <a name="designing-a-xamarinmac-app-for-the-app-sandbox"></a>Разработка приложения Xamarin. Mac для песочницы приложения

При проектировании приложения Xamarin. Mac для песочницы приложения следует выполнить общий рабочий процесс. С другой стороны, особенности реализации песочницы в приложении будут уникальными для функций конкретного приложения.

### <a name="six-steps-for-adopting-the-app-sandbox"></a>Шесть шагов по внедрению песочницы приложения

Разработка приложения Xamarin. Mac для песочницы приложения обычно состоит из следующих шагов:

1. Определите, подходит ли приложение для "песочницы".
2. Разработка стратегии разработки и распространения.
3. Устраните все несовместимости API.
4. Примените необходимые права песочницы приложения к проекту Xamarin. Mac.
5. Добавление разделения привилегий с помощью КСПК.
6. Реализуйте стратегию миграции.

> [!IMPORTANT]
> Вы должны не только изолировать основной исполняемый файл в пакете приложений, но и все включенное вспомогательное приложение или инструмент в этом пакете. Это необходимо для любого приложения, распространяемого из Mac App Store, и, если это возможно, должно выполняться для любой другой формы распространения приложений.

Чтобы получить список всех исполняемых двоичных файлов в пакете приложения Xamarin. Mac, введите следующую команду в окне терминала:

```bash
find -H [Your-App-Bundle].app -print0 | xargs -0 file | grep "Mach-O .*executable"
```

Где `[Your-App-Bundle]` — имя и путь к пакету приложения.

### <a name="determine-whether-a-xamarinmac-app-is-suitable-for-sandboxing"></a>Определите, подходит ли приложение Xamarin. Mac для изолирования

Большинство приложений Xamarin. Mac полностью совместимы с песочницей приложения и, следовательно, подходит для изолирования. Если приложению требуется поведение, которое не разрешено песочницей приложения, следует рассмотреть альтернативный подход.

Если приложению требуется одно из следующих поведений, оно несовместимо с песочницей приложения:

- **Службы авторизации** . с помощью песочницы приложения вы не можете работать с функциями, описанными в [справочнике по службам авторизации C](https://developer.apple.com/library/prerelease/mac/documentation/Security/Reference/authorization_ref/index.html#//apple_ref/doc/uid/TP30000826).
- **Интерфейсы специальных возможностей** . Вы не можете изолировать вспомогательные приложения, такие как средства чтения с экрана или приложения, управляющие другими приложениями.
- **Отправка событий Apple в произвольные приложения** . Если приложению требуется отправка событий Apple неизвестного, произвольного приложения, оно не может быть изолировано. Для известного списка приложений, которые называются "песочницой", приложение по-прежнему может быть изолировано, а права должны включать список вызываемых приложений.
- **Отправлять словари сведений о пользователях из распределенных уведомлений в другие задачи** . с помощью песочницы приложения нельзя включать словарь `userInfo` при публикации в объект `NSDistributedNotificationCenter` для других задач обмена сообщениями.
- **Загрузка расширений ядра** . Загрузка расширений ядра запрещена песочницей приложения.
- **Имитация ввода данных пользователем в диалоговых окнах открытия и сохранения** — программное управление диалоговыми окнами открытия и сохранения для имитации или изменения вводимых пользователем данных запрещено песочницей приложения.
- **Доступ к настройкам и их настройка в других приложениях** . Управление параметрами других приложений запрещено песочницей приложения.
- **Настройка параметров сети** — Управление параметрами сети запрещено песочницей приложения.
- **Завершение работы других приложений** . Песочница приложения запрещает использование `NSRunningApplication` для завершения других приложений.

### <a name="resolving-api-incompatibilities"></a>Разрешение несовместимости API

При проектировании приложения Xamarin. Mac для песочницы приложения может возникнуть несовместимость с использованием некоторых API-интерфейсов macOS.

Ниже приведены некоторые распространенные проблемы и действия, которые можно решить:

- **Открытие, сохранение и отслеживание документов** . Если вы управляете документами с помощью любой технологии, отличной от `NSDocument`, следует переключиться на него из-за встроенной поддержки песочницы приложения. `NSDocument` автоматически работает с Повербокс и обеспечивает поддержку хранения документов в песочнице, если пользователь переместит их в Finder.
- **Сохранение доступа к ресурсам файловой системы** . Если приложение Xamarin. Mac зависит от постоянного доступа к ресурсам за пределами своего контейнера, используйте закладки уровня безопасности для поддержания доступа.
- **Создание элемента входа для приложения** . с помощью "песочницы" приложения нельзя создать элемент входа с помощью `LSSharedFileList`, а также управлять состоянием служб запуска с помощью `LSRegisterURL`. Используйте функцию `SMLoginItemSetEnabled`, как описано в разделе яблоко [Добавление элементов входа с помощью документации по платформе управления службами](https://developer.apple.com/library/prerelease/mac/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLoginItems.html#//apple_ref/doc/uid/10000172i-SW5-SW1) .
- **Доступ к данным пользователя** . Если вы используете функции POSIX, например `getpwuid` для получения домашнего каталога пользователя из служб каталогов, рассмотрите возможность использования символов Cocoa или Core Foundation, таких как `NSHomeDirectory`.
- **Доступ к предпочтениям других приложений** — поскольку Песочница приложений направляет API-интерфейсы поиска пути в контейнер приложения, изменение предпочтений происходит в этом контейнере и доступ к другим настройкам приложений в запрещено.
- **Использование встроеного видео HTML5 в веб-представлениях** . Если приложение Xamarin. Mac использует WebKit для воспроизведения внедренных видеороликов HTML5, необходимо также связать приложение с платформой AV Foundation Framework. Изолированная среда приложения не позволит Коремедиа воспроизвести эти видео в противном случае.

### <a name="applying-required-app-sandbox-entitlements"></a>Применение необходимых прав песочницы приложения

Вам потребуется изменить права для любого приложения Xamarin. Mac, которое требуется запустить в песочнице приложения, и установить флажок **включить изолированную среду приложений** .

В зависимости от функциональных возможностей приложения может потребоваться включить другие права доступа к функциям или ресурсам ОС. Изолированное приложение работает наилучшим образом, когда вы уменьшаете количество прав, необходимое для запуска приложения, так что нужно лишь случайным образом включить права.

Чтобы определить, какие права требуются для приложения Xamarin. Mac, выполните следующие действия.

1. Включите песочницу приложения и запустите приложение Xamarin. Mac.
2. Выполните функции приложения.
3. Откройте консольное приложение (доступно в `/Applications/Utilities`) и найдите нарушения `sandboxd` в журнале **все сообщения** .
4. Для каждого нарушения `sandboxd` устраните проблему либо с помощью контейнера приложения, а не из других расположений файловой системы, либо примените права песочницы приложения, чтобы обеспечить доступ к ограниченным функциям ОС.
5. Повторно запустите и протестируйте все компоненты приложения Xamarin. Mac снова.
6. Повторяйте, пока не будут устранены все нарушения `sandboxd`.

### <a name="add-privilege-separation-using-xpc"></a>Добавление разделения привилегий с помощью КСПК

При разработке приложения Xamarin. Mac для песочницы приложения изучите поведение приложения в условиях привилегий и доступа, а затем рассмотрите возможность отделения операций с высоким риском к собственным КСПК службам.

Дополнительные сведения см. в статье о [создании Кспк служб](https://developer.apple.com/library/prerelease/mac/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingXPCServices.html#//apple_ref/doc/uid/10000172i-SW6) и [управляющих программ и демонов](https://developer.apple.com/library/prerelease/mac/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/Introduction.html#//apple_ref/doc/uid/10000172i)Apple.

### <a name="implement-a-migration-strategy"></a>Реализация стратегии миграции

Если вы выпустили новую изолированную версию приложения Xamarin. Mac, которая ранее не была изолирована, необходимо убедиться, что у текущих пользователей есть путь плавного обновления.

 Дополнительные сведения о реализации манифеста миграции контейнеров см. в документации Apple о [переносе приложения в "песочницу"](https://developer.apple.com/library/prerelease/mac/documentation/Security/Conceptual/AppSandboxDesignGuide/MigratingALegacyApp/MigratingAnAppToASandbox.html#//apple_ref/doc/uid/TP40011183-CH6-SW1) .

## <a name="summary"></a>Сводка

В этой статье подробно рассматривается изолированное приложение Xamarin. Mac. Во-первых, мы создали простое приложение Xamarin. Mac, чтобы продемонстрировать основы песочницы приложения. Далее мы показали, как разрешать нарушения "песочницы". Затем мы потратили углубленный взгляд на песочницу приложения и, наконец, рассматривали создание приложения Xamarin. Mac для песочницы приложения.

## <a name="related-links"></a>Связанные ссылки

- [Публикация в App Store](~/mac/deploy-test/publishing-to-the-app-store/index.md)
- [О песочнице приложения](https://developer.apple.com/library/content/documentation/Security/Conceptual/AppSandboxDesignGuide/AboutAppSandbox/AboutAppSandbox.html)
- [Распространенные проблемы изолированного приложения](https://developer.apple.com/library/content/qa/qa1773/_index.html)
