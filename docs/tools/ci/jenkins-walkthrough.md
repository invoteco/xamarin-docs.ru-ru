---
title: Использование Jenkins с Xamarin
description: В этом документе описывается, как использовать Jenkins для непрерывной интеграции с приложениями Xamarin. В нем обсуждается установка, Настройка и использование Jenkins.
ms.prod: xamarin
ms.assetid: 1E6825DF-1254-4FCB-B94D-ADD33D1B5309
author: davidortinau
ms.author: daortin
ms.date: 03/23/2017
ms.openlocfilehash: 6d420faf59d940bb111b5ecd326a29083cab012e
ms.sourcegitcommit: 2fbe4932a319af4ebc829f65eb1fb1816ba305d3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/29/2019
ms.locfileid: "73029911"
---
# <a name="using-jenkins-with-xamarin"></a>Использование Jenkins с Xamarin

_В этом руководство показано, как настроить Jenkins в качестве сервера непрерывной интеграции и автоматизировать компиляцию мобильных приложений, созданных с помощью Xamarin. В нем описывается установка Jenkins в OS X, Настройка и Настройка заданий для компиляции приложений Xamarin. iOS и Xamarin. Android при фиксации изменений в системе управления исходным кодом._

[Введение в непрерывную интеграцию с Xamarin](~/tools/ci/intro-to-ci.md) обеспечивает непрерывную интеграцию в качестве полезной методики разработки программного обеспечения, которая предоставляет раннее предупреждение о нарушенном или несовместимом коде. CI позволяет разработчикам решать проблемы и проблемы по мере их возникновения и сохраняет программное обеспечение в подходящем для развертывания состоянии. В этом пошаговом руководстве описывается, как использовать содержимое из обоих документов вместе.

В этом руководство показано, как установить Jenkins на выделенном компьютере под управлением OS X и настроить его для автоматического запуска при запуске компьютера. После установки Jenkins будут установлены дополнительные подключаемые модули для поддержки сборки MS. Jenkins поддерживает Git из Box. Если TFS используется для управления исходным кодом, также необходимо установить дополнительный подключаемый модуль и служебные программы командной строки.

После настройки Jenkins и установки всех необходимых подключаемых модулей мы создадим одно или несколько заданий для компиляции проектов Xamarin. Android и Xamarin. iOS. Задание — это набор шагов и метаданных, необходимых для выполнения некоторой работы. Обычно задание состоит из следующих компонентов:

- **Управление исходным кодом (SCM)** — это запись метаданных в файлах конфигурации Jenkins, которая содержит сведения о подключении к системе управления версиями и извлекаемым файлам.
- **Триггеры** — триггеры используются для запуска задания на основе определенных действий, например, когда разработчик фиксирует изменения в репозитории исходного кода.
- **Инструкции по сборке** — это подключаемый модуль или сценарий, который выполнит компиляцию исходного кода и создаст двоичный файл, который можно установить на мобильных устройствах.
- **Необязательные действия сборки** — это может включать Запуск модульных тестов, выполнение статического анализа кода, подписывание кода или запуск другого задания для выполнения других задач, связанных с построением.
- **Уведомления** — задание может отправлять некоторые уведомления о состоянии сборки.
- **Безопасность** — хотя это необязательно, настоятельно рекомендуется также включить функции безопасности Jenkins.

В этом руководстве описано, как настроить сервер Jenkins, охватывающий каждую из этих точек. В конце ИТ-отделов у нас должно быть хорошее представление о настройке и настройке Jenkins для создания IPA и APK для проектов Xamarin Mobile.

## <a name="requirements"></a>Требования

Идеальный сервер сборки — это автономный компьютер, предназначенный исключительно для создания и, возможно, тестирования приложения. Выделенный компьютер гарантирует, что артефакты, которые могут потребоваться для других ролей (например, веб-сервера), не загрязнять сборку. Например, если сервер сборки также выступает в роли веб-сервера, для веб-сервера может потребоваться конфликтующая версия некоторых распространенных библиотек. В связи с этим конфликт веб-сервер может работать неправильно или Jenkins может создавать сборки, которые не работают при развертывании для пользователей.

Сервер сборки для мобильных приложений Xamarin настраивается почти так же, как Рабочая станция разработчика. Он имеет учетную запись пользователя, в которой будут установлены Jenkins, Visual Studio для Mac, Xamarin. iOS и Xamarin. Android. Также необходимо установить все сертификаты подписи кода, профили подготовки и хранилища ключей. *Обычно учетная запись пользователя сервера сборки отличается от учетных записей разработчиков. обязательно установите и настройте все программное обеспечение, ключи и сертификаты во время входа с использованием учетной записи пользователя сервера сборки.*

На следующей схеме показаны все эти элементы на типичном сервере сборки Jenkins:

[![](jenkins-walkthrough-images/image1.png "This diagram illustrates all of these elements on a typical Jenkins build server")](jenkins-walkthrough-images/image1.png#lightbox)

приложения iOS могут быть созданы и подписаны только на компьютере с macOS. Mac Mini является разумным вариантом с меньшими затратами, но достаточно любого компьютера, работающего под управлением OS X 10,10 (Yosemite) или более поздней версии.

Если TFS используется для управления исходным кодом, потребуется установить [Team Explorer Everywhere](https://docs.microsoft.com/azure/devops/java/download-eclipse-plug-in/). Team Explorer Everywhere предоставляет кросс-платформенный доступ к TFS в терминале в macOS.

[!include[](~/tools/ci/includes/firewall-information.md)]

## <a name="installing-jenkins"></a>Установка Jenkins

Первая задача по использованию Jenkins — установить ее. Существует три способа запуска Jenkins в OS X:

- В качестве управляющей программы в фоновом режиме.
- Внутри контейнера сервлета, такого как Tomcat, Jetty или JBoss.
- Как обычная процедура, выполняемая под учетной записью пользователя.

Большинство традиционных приложений для непрерывной интеграции выполняются в фоновом режиме: как управляющая программа (в OS X или \*NIX) или как услуга (в Windows). Это подходит для сценариев, где не требуется взаимодействие с графическим пользовательским интерфейсом и где можно легко выполнить настройку среды сборки. Для мобильных приложений также требуются хранилища ключей и сертификаты подписи, которые могут оказаться проблематичными для доступа, когда Jenkins работает в качестве управляющей программы. Из-за этих проблем этот документ посвящен третьему сценарию — запуску Jenkins под учетной записью пользователя на сервере сборки.

Jenkins. app — это удобный способ установки Jenkins. Это оболочка AppleScript, которая упрощает запуск и остановку сервера Jenkins. Вместо запуска в оболочке bash Jenkins выполняется как приложение со значком в закрепления, как показано на следующем снимке экрана:

[![](jenkins-walkthrough-images/image2.png "Instead of running in a bash shell, Jenkins runs as an app with icon in the Dock, as shown in this screenshot")](jenkins-walkthrough-images/image2.png#lightbox)

Запуск или остановка Jenkins выполняется так же просто, как запуск или остановка Jenkins. app.

Чтобы установить Jenkins. app, скачайте последнюю версию со страницы скачивания проекта, представленной на снимке экрана ниже:

[![](jenkins-walkthrough-images/image3.png "App, download the latest version from the projects download page, pictured in this screenshot")](jenkins-walkthrough-images/image3.png#lightbox)

Извлеките ZIP-файл в папку `/Applications` на сервере сборки и запустите его так же, как и любое другое приложение OS X.
При первом запуске Jenkins. app появится диалоговое окно с сообщением о том, что будет загружено Jenkins:

[![](jenkins-walkthrough-images/image4.png "App, it will present a dialog informing you that it will download Jenkins")](jenkins-walkthrough-images/image4.png#lightbox)

После завершения загрузки Jenkins. app отобразится еще одно диалоговое окно с предложением настроить запуск Jenkins, как показано на следующем снимке экрана:

[![](jenkins-walkthrough-images/image5.png "App has finished its download, it will display another dialog asking you if you would like to customize the Jenkins startup, as seen in this screenshot")](jenkins-walkthrough-images/image5.png#lightbox)

Настройка Jenkins является необязательной и не должна выполняться каждый раз при запуске приложения — параметры по умолчанию для Jenkins будут работать в большинстве случаев.

Если необходимо настроить Jenkins, нажмите кнопку **изменить значения по умолчанию** . Появится два последовательных диалоговых окна: один из них запрашивает параметры командной строки Java, а другой — запрос параметров командной строки Jenkins. Эти два диалоговых окна показаны на двух следующих снимках экрана:

[![](jenkins-walkthrough-images/image6.png "This screenshot shows the dialogs")](jenkins-walkthrough-images/image6.png#lightbox)

[![](jenkins-walkthrough-images/image7.png "This screenshot shows the dialogs")](jenkins-walkthrough-images/image7.png#lightbox)

После запуска Jenkins может потребоваться задать его в качестве элемента входа, чтобы он запускался при каждом входе пользователя на компьютер. Это можно сделать, щелкнув правой кнопкой мыши значок Jenkins на закрепления и выбрав пункт **Параметры... > Открыть при входе**, как показано на следующем снимке экрана:

[![](jenkins-walkthrough-images/image8.png "You can do this by right-clicking on the Jenkins icon in the Dock and choosing OptionsOpen at Login, as shown in this screenshot")](jenkins-walkthrough-images/image8.png#lightbox)

Это приведет к автоматическому запуску Jenkins. App при каждом входе пользователя в систему, но не при загрузке компьютера. Можно указать учетную запись пользователя, которую OS X будет использовать для автоматического входа в систему во время загрузки. Откройте **Системные настройки**и выберите значок **Пользователи & группы** , как показано на следующем снимке экрана:

[![](jenkins-walkthrough-images/image9.png "Open the System Preferences, and select the User  Groups icon as shown in this screenshot")](jenkins-walkthrough-images/image9.png#lightbox)

Нажмите кнопку **Параметры входа** , а затем выберите учетную запись, которую OS X будет использовать для входа во время загрузки.

На этом этапе Jenkins установлен. Тем не менее, если требуется создавать мобильные приложения Xamarin, необходимо установить некоторые подключаемые модули.

### <a name="installing-plugins"></a>Установка подключаемых модулей

Когда установщик Jenkins. app завершит работу, он запустится Jenkins и запустит веб-браузер с URL-адресом http://localhost:8080, как показано на снимке экрана ниже:

[![](jenkins-walkthrough-images/image10.png "8080, as shown in this screenshot")](jenkins-walkthrough-images/image10.png#lightbox)

На этой странице выберите **Jenkins > управление Jenkins > управление подключаемыми** модулями в меню в верхнем левом углу, как показано на снимке экрана ниже:

[![](jenkins-walkthrough-images/image11.png "From this page, select Jenkins  Manage Jenkins  Manage Plugins from the menu in the upper left hand corner")](jenkins-walkthrough-images/image11.png#lightbox)

Отобразится страница **диспетчера подключаемого модуля Jenkins** . Щелкнув вкладку Доступные, вы увидите список из более чем 600 подключаемых модулей, которые можно скачать и установить. Этот рисунок показан на снимке экрана ниже:

[![](jenkins-walkthrough-images/image12.png "If you click on the Available tab, you will see a list of over 600 plugins that can be downloaded and installed")](jenkins-walkthrough-images/image12.png#lightbox)

Прокрутка всех подключаемых модулей 600, чтобы найти несколько, может быть утомительной и подвержена ошибкам. Jenkins предоставляет поле фильтра поиска в верхнем правом углу интерфейса. Использование этого поля фильтра для поиска упростит поиск и установку одного или всех следующих подключаемых модулей:

- **Подключаемый модуль Jenkins MSBuild** — этот подключаемый модуль позволяет создавать решения Visual Studio и Visual Studio для Mac (SLN) и проекты (. csproj).
- **Подключаемый модуль инжектор среды** — это необязательный, но полезный подключаемый модуль, позволяющий задавать переменные среды на уровне задания и сборки. Он также обеспечивает дополнительную защиту для переменных, таких как пароли, используемые для подписания приложения. Иногда он сокращается как *подключаемый модуль енвинжект* .
- **Подключаемый модуль Team Foundation Server** — это дополнительный подключаемый модуль, который требуется только при использовании Team Foundation Server или служб Team Foundation Services для управления исходным кодом.

Jenkins поддерживает Git без дополнительных подключаемых модулей.

После установки всех подключаемых модулей необходимо перезапустить Jenkins и настроить глобальные параметры для каждого подключаемого модуля. Глобальные параметры для подключаемого модуля можно найти, выбрав **Jenkins > управление Jenkins > настроить систему** в левом верхнем углу, как показано на снимке экрана ниже:

[![](jenkins-walkthrough-images/image13.png "The global settings for a plugin can be found by selecting Jenkins / Manage Jenkins / Configure System from the upper left hand corner")](jenkins-walkthrough-images/image13.png#lightbox)

При выборе этого пункта меню появится страница **Настройка системы [Jenkins]** . На этой странице содержатся разделы для настройки самого Jenkins и задания некоторых значений глобального подключаемого модуля.  На следующем снимке экрана показан пример этой страницы:

[![](jenkins-walkthrough-images/image14.png "This screenshot illustrates an example of this page")](jenkins-walkthrough-images/image14.png#lightbox)

#### <a name="configuring-the-msbuild-plugin"></a>Настройка подключаемого модуля MSBuild

Подключаемый модуль MSBuild должен быть настроен на использование **/либрари/фрамеворкс/моно.фрамеворк/коммандс/ксбуилд** для компиляции Visual Studio для Mac файлов решения и проекта. Прокрутите страницу **Настройка системы [Jenkins]** до тех пор, пока не появится кнопка **Добавить MSBuild** , как показано на снимке экрана ниже:

 [![](jenkins-walkthrough-images/image15.png "Scroll down the Configure System Jenkins page until the Add MSBuild button appears")](jenkins-walkthrough-images/image15.png#lightbox)

Нажмите эту кнопку и введите **имя** и **путь** к полям **MSBuild** в появившейся форме. Имя установки **MSBuild** должно быть осмысленным, а **путь к MSBuild** — это путь к `xbuild`, который обычно **/либрари/фрамеворкс/моно.фрамеворк/коммандс/ксбуилд**. После сохранения изменений нажатием кнопки сохранить или применить в нижней части страницы Jenkins сможет использовать `xbuild` для компиляции решений.

#### <a name="configuring-the-tfs-plugin"></a>Настройка подключаемого модуля TFS

Этот раздел является обязательным, если вы планируете использовать TFS для управления исходным кодом.

Чтобы Рабочая станция macOS взаимодействовала с сервером TFS, на рабочей станции должен быть установлен [Team Explorer Everywhere](https://docs.microsoft.com/azure/devops/java/download-eclipse-plug-in/) . Team Explorer Everywhere — это набор средств корпорации Майкрософт, включающий Межплатформенный клиент командной строки для доступа к TFS. Team Explorer Everywhere можно загрузить из корпорации Майкрософт и установить в три этапа:

1. Распакуйте файл архива в каталог, доступный для учетной записи пользователя. Например, вы можете распаковать файл в **~/ти**.
2. Настройте оболочку или системный путь для включения папки, содержащей файлы, которые были распакованы на предыдущем шаге. Например, примененная к объекту директива

    ```
    echo export PATH~/tee/:$PATH' >> ~/.bash_profile
    ```

3. Чтобы убедиться, что Team Explorer Everywhere установлен, откройте сеанс терминала и выполните команду `tf`. Если программа TF настроена правильно, вы увидите в сеансе терминала следующие выходные данные:

    ```
    $ tf
    Team Explorer Everywhere Command Line Client (version 11.0.0.201306181526)

    Available commands and their options:
    ```

После установки клиента командной строки для TFS в Jenkins должен быть указан полный путь к `tf` клиенту командной строки. Прокрутите страницу **Настройка системы [Jenkins]** , пока не найдете раздел Team Foundation Server, как показано на следующем снимке экрана:

[![](jenkins-walkthrough-images/image17.png "Scroll down the Configure System Jenkins page until you find the Team Foundation Server section")](jenkins-walkthrough-images/image17.png#lightbox)

Введите полный путь к команде `tf` и нажмите кнопку **сохранить** .

### <a name="configure-jenkins-security"></a>Настройка безопасности Jenkins

При первой установке Jenkins отключает безопасность, поэтому любой пользователь может анонимно настраивать и запускать любые задания. В этом разделе описано, как настроить безопасность с помощью пользовательской базы данных Jenkins для настройки проверки подлинности и авторизации.

Параметры безопасности можно найти, выбрав **Jenkins > управление Jenkins > настроить глобальную безопасность**, как показано на следующем снимке экрана:

[![](jenkins-walkthrough-images/image18.png "Security settings can be found by selecting Jenkins / Manage Jenkins / Configure Global Security")](jenkins-walkthrough-images/image18.png#lightbox)

На странице **Настройка глобальной безопасности** установите флажок **включить безопасность** и убедитесь, что на следующем снимке экрана показана форма **контроля доступа** .

[![](jenkins-walkthrough-images/image19.png "On the Configure Global Security page, check the Enable Security checkbox and the Access Control form should appear, similar to this screenshot")](jenkins-walkthrough-images/image19.png#lightbox)

Включите переключатель для **Jenkins "собственная пользовательская база данных"** в **области безопасности**и убедитесь, что флажок **Разрешить пользователям регистрировать** также установлен, как показано на следующем снимке экрана:

[![](jenkins-walkthrough-images/image20.png "Toggle the radio button for Jenkins own user database in the Security Realm Section, and ensure that Allow users to sign up is also checked")](jenkins-walkthrough-images/image20.png#lightbox)

Наконец, перезапустите Jenkins и создайте новую учетную запись. Первая созданная учетная запись является учетной записью root, а эта учетная запись автоматически становится администратором. Вернитесь на страницу **Настройка глобальной безопасности** и установите флажок для параметра **безопасность на основе матрицы** . Учетной записи root следует предоставить полный доступ, а анонимная учетная запись должна иметь доступ только для чтения, как показано на следующем снимке экрана:

[![](jenkins-walkthrough-images/image21.png "The root account should be granted full access, and the anonymous account should be given read-only access")](jenkins-walkthrough-images/image21.png#lightbox)

После сохранения этих параметров и перезапуска Jenkins безопасность будет включена.

#### <a name="disabling-security"></a>Отключение безопасности

В случае забытого пароля или блокировки на уровне Jenkins можно отключить безопасность, выполнив следующие действия.

1. Останавливает Jenkins. Если вы используете Jenkins. app, это можно сделать, щелкнув правой кнопкой мыши значок Jenkins. app на закрепления и выбрав команду выйти в открывшемся меню:

    ![Значок приложения на закрепления и выбрать команду "выход" в появившемся меню](jenkins-walkthrough-images/image19.png)

2. Откройте файл **~/.женкинс/конфиг.ксмл** в текстовом редакторе.
3. Измените значение элемента `<usesecurity></usesecurity>` с `true` на `false`.
4. Удалите `<authorizationstrategy></authorizationstrategy>` и элементы `<securityrealm></securityrealm>` из файла.
5. Перезапустите Jenkins.

## <a name="setting-up-a-job"></a>Настройка задания

На верхнем уровне Jenkins организует все различные задачи, необходимые для создания программного обеспечения в *задании*. С заданием также связаны метаданные, предоставляющие сведения о сборке, такие как получение исходного кода, периодичность выполнения сборки, любые специальные переменные, необходимые для построения, а также уведомление разработчиков в случае сбоя сборки.

Задания создаются путем выбора **Jenkins > создать задание** в меню в правом верхнем углу, как показано на следующем снимке экрана:

![](jenkins-walkthrough-images/image22.png "Jobs are created by selecting Jenkins  New Job from the menu in the upper right hand corner")

Отобразится страница **Создание задания [Jenkins]** . Введите имя задания и выберите переключатель **создать проект для программного обеспечения в свободном стиле** . На следующем снимке экрана показан пример.

![](jenkins-walkthrough-images/image23.png "Enter a name for the job, and select the Build a free-style software project radio button")

При нажатии кнопки **ОК** отображается страница настройки для задания. Это должно быть похоже на следующий снимок экрана:

![](jenkins-walkthrough-images/image24.png "This should resemble this screenshot")

Jenkins организует задания в каталоге на жестком диске, расположенном по следующему пути: **~/.женкинс/Жобс/[имя задания]** .

Эта папка содержит все файлы и артефакты, относящиеся к заданию, такие как журналы, файлы конфигурации и исходный код, который необходимо скомпилировать.

После создания первоначального задания его необходимо настроить с помощью одного или нескольких из следующих элементов:

- Должна быть указана система управления исходным кодом.
- В проект необходимо добавить одно или несколько *действий сборки* . Это шаги или задачи, необходимые для построения приложения.
- Задание должно быть назначено одним *триггером сборки* — набором инструкций, Jenkins, как часто требуется получить код и построить окончательный проект.

### <a name="configuring-source-code-control"></a>Настройка управления исходным кодом

Первая задача, Jenkins, — это получение исходного кода из системы управления исходным кодом. Jenkins поддерживает многие популярные системы управления исходным кодом, доступные на сегодняшний день. В этом разделе рассматриваются две популярные системы, Git и Team Foundation Server. Каждая из этих систем управления исходным кодом обсуждается более подробно в следующих разделах.

#### <a name="using-git-for-source-code-control"></a>Использование Git для управления исходным кодом

Если вы используете TFS для управления исходным кодом, [пропустите](#using-tfs-for-source-code-management) этот раздел и перейдите к следующему разделу с помощью TFS.

Jenkins поддерживает Git из Box — дополнительные подключаемые модули не требуются. Чтобы использовать Git, щелкните переключатель **Git** и введите URL-адрес репозитория Git, как показано на следующем снимке экрана:

![](jenkins-walkthrough-images/image25.png "To use Git, click on the Git radio button and enter the URL for the Git repository")

После сохранения изменений настройка Git завершена.

#### <a name="using-tfs-for-source-code-management"></a>Использование TFS для управления исходным кодом

Этот раздел применим только к пользователям TFS.

Щелкните переключатель **Team Foundation Server** и отобразится раздел Конфигурация TFS, аналогичный показанному на следующем снимке экрана:

![](jenkins-walkthrough-images/image26.png "Click on the Team Foundation Server radio button and the TFS configuration section should appear")

Укажите необходимые сведения для TFS. На следующем снимке экрана показан пример готовой формы:

![](jenkins-walkthrough-images/image27.png "This screenshot shows an example of the completed form")

#### <a name="testing-the-source-code-control-configuration"></a>Тестирование конфигурации системы управления исходным кодом

После настройки соответствующего управления исходным кодом нажмите кнопку **сохранить** , чтобы сохранить изменения. Будет возвращена Домашняя страница задания, которая будет выглядеть примерно на следующем снимке экрана:

![](jenkins-walkthrough-images/image28.png "This will return you to the home page for the job, which will resemble this screenshot")

Самый простой способ проверить правильность настройки управления исходным кодом — запустить сборку вручную, даже если не указано никаких действий сборки. Для запуска сборки вручную Домашняя страница задания имеет ссылку **Сборка** в меню на левой стороне, как показано на снимке экрана ниже:

![](jenkins-walkthrough-images/image29.png "To start a build manually, the home page of the job has a Build Now link in the menu on the left hand side")

При запуске сборки в диалоговом окне Журнал сборки отображается мигающий синий круг, индикатор выполнения, номер сборки и время начала сборки, как показано на следующем снимке экрана:

![](jenkins-walkthrough-images/image30.png "When a build has been started, the Build History dialog displays a flashing blue circle, a progress bar, the build number and the time that the build started")

Если задание выполняется, появится синий круг. В случае сбоя задания отображается красный круг.

Чтобы помочь в устранении неполадок, которые могут возникнуть в ходе сборки, Jenkins захватывает все выходные данные консоли для задания. Чтобы просмотреть выходные данные консоли, щелкните задание в **журнале сборок**, а затем щелкните ссылку **выходные данные консоли** в меню слева. На следующем снимке экрана показана ссылка на **выходные данные консоли** , а также некоторые выходные данные успешного задания:

![](jenkins-walkthrough-images/image31.png "This screenshot shows the Console Output link, as well as some of the output from a successful job")

#### <a name="location-of-build-artifacts"></a>Расположение артефактов сборки

Jenkins будет получать весь исходный код в специальную папку, называемую *рабочей областью*. Этот каталог можно найти в папке по следующему адресу:

```
~/.jenkins/jobs/[JOB NAME]/workspace
```

Путь к рабочей области будет храниться в переменной среды с именем `$WORKSPACE`.

Можно просмотреть папку рабочей области в Jenkins, перейдя на целевую страницу задания, а затем щелкнув ссылку на **рабочую область** в меню слева. На следующем снимке экрана показан пример рабочей области для задания с именем **HelloWorld**:

![](jenkins-walkthrough-images/image32.png "This screenshot shows an example of the workspace for a job named HelloWorld")

### <a name="build-triggers"></a>Триггеры сборки

Существует несколько различных стратегий для инициации сборок в Jenkins — они называются *триггерами сборки*. Триггер сборки помогает Jenkins решить, когда следует запускать задание и выполнять сборку проекта. Два наиболее распространенных триггера сборки:

- **Периодическая сборка** — этот триггер приводит к тому, что Jenkins запускает задание через определенные интервалы, например каждые два часа или полночь в день недели. Сборка начнется независимо от того, были ли изменения в репозитории исходного кода.
- **ОПРОСИТЬ SCM** — этот триггер будет регулярно опрашивать управление исходным кодом. Если какие-либо изменения были зафиксированы в репозитории исходного кода, Jenkins начнет новую сборку.

Опрос SCM является популярным триггером, так как он обеспечивает быструю обратную связь, когда разработчик фиксирует изменения, которые приводят к сбою сборки. Это полезно для групп предупреждений о том, что некоторый недавно зафиксированный код вызывает проблемы, и позволяет разработчикам решить эту проблему, в то время как изменения по-прежнему обновляются.

Периодические сборки часто используются для создания версии приложения, которая может распространяться на тестировщиков. Например, периодическая сборка может быть запланирована на пятницу вечером, чтобы члены группы контроля качества могли протестировать работу предыдущей недели.

### <a name="compiling-a-xamarinios-applications"></a>Компиляция приложений Xamarin. iOS
Проекты Xamarin. iOS можно компилировать в командной строке с помощью `xbuild` или `msbuild`. Команда Shell будет выполняться в контексте учетной записи пользователя, на которой выполняется Jenkins. Важно, чтобы у учетной записи пользователя был доступ к профилю подготовки, чтобы приложение можно было правильно упаковать для распространения. Эту команду оболочки можно добавить на страницу конфигурации задания.

Прокрутите вниз до раздела **Build (сборка** ). Нажмите кнопку **Добавить шаг построения** и выберите команду **Выполнить оболочку**, как показано на снимке экрана ниже.

![](jenkins-walkthrough-images/image33.png "Click the Add build step button and select Execute shell")

[!include[](~/tools/ci/includes/commandline-compile-of-xamarin-ios-ipa.md)]

### <a name="building-a-xamarinandroid-project"></a>Сборка проекта Xamarin. Android

Сборка проекта Xamarin. Android очень похожа на концепцию сборки проекта Xamarin. iOS. Чтобы создать APK из проекта Xamarin. Android, необходимо настроить Jenkins для выполнения следующих двух шагов:

- Компиляция проекта с помощью подключаемого модуля MSBuild
- Подпишите и ZIP-файл APK с допустимым хранилищем ключей выпуска.

Эти два действия будут подробно рассмотрены в следующих двух разделах.

### <a name="creating-the-apk"></a>Создание APK

Нажмите кнопку **Добавить шаг построения** и выберите **создать проект или решение Visual Studio с помощью MSBuild**, как показано на снимке экрана ниже:

![](jenkins-walkthrough-images/image36.png "Creating the APK  Click on the Add build step button, and select Build a Visual Studio project or solution using MSBuild")

После добавления шага сборки в проект заполните поля формы, которые отображаются. На следующем снимке экрана приведен один из примеров готовой формы:

![](jenkins-walkthrough-images/image37.png "Once the build step is added to the project, fill in the form fields that appear")

Этот шаг сборки будет выполнен `xbuild` в папке **$Workspace** . Для файла сборки MSBuild задается файл **Xamarin. Android. csproj** . **Аргументы командной строки** указывают сборку выпуска целевого **PackageForAndroid**. Продукт этого шага будет APK в следующем расположении:

```
$WORKSPACE/[PROJECT NAME]/bin/Release
```

На следующем снимке экрана показан пример этого APK:

![](jenkins-walkthrough-images/image38.png "This screenshot shows an example of this APK")

Эта APK не готова к развертыванию, так как она не подписана частным хранилищем ключей и должна быть упорядочена по ZIP.

#### <a name="signing-and-zipaligning-the-apk-for-release"></a>Подписывание и оптимизированный APK для выпуска

Подписывание и оптимизированный APK технически являются двумя отдельными задачами, выполняемыми двумя отдельными программами командной строки из пакет SDK для Android. Однако их удобно выполнять в одном действии сборки. Дополнительные сведения о подписывании и оптимизированный APK см. в документации по Xamarin, посвященной подготовке приложения Android для выпуска.

Обе эти команды занимают параметры командной строки, которые могут отличаться от Project к Project. Кроме того, некоторые из этих параметров командной строки являются паролями, которые не должны отображаться в выходных данных консоли при выполнении сборки. Некоторые из этих параметров командной строки будут храниться в переменных среды. Переменные среды, необходимые для подписывания и/или рассогласования ZIP, описаны в следующей таблице:

|Переменная среды|Описание|
|--- |--- |
|KEYSTORE_FILE|Это путь к хранилищу ключей для подписи APK|
|KEYSTORE_ALIAS|Ключ в хранилище ключей, который будет использоваться для подписи APK.|
|INPUT_APK|APK, созданный `xbuild`.|
|SIGNED_APK|Подписанный APK, созданный `jarsigner`.|
|FINAL_APK|Это APK с согласованием по ZIP, который создается `zipalign`.|
|STORE_PASS|Это пароль, который используется для доступа к содержимому хранилища ключей для подписания файла.|

Как описано в разделе требования, эти переменные среды можно задать во время сборки с помощью подключаемого модуля Енвинжект. Для задания должен быть добавлен новый шаг сборки на основе переменных среды вставки, как показано на следующем снимке экрана:

![](jenkins-walkthrough-images/image39.png "The job should have a new build step added based on the Inject environment variables")

В отображаемом поле формы **содержимого свойств** добавляются переменные среды, по одной на строку в следующем формате:

```
ENVIRONMENT_VARIABLE_NAME = value
```

На следующем снимке экрана показаны переменные среды, необходимые для подписи APK:

![](jenkins-walkthrough-images/image40.png "This screenshot shows the environment variables that are required for signing the APK")

Обратите внимание, что некоторые переменные среды для файлов APK построены на основе переменной среды `WORKSPACE`.

Последняя переменная среды — это пароль для доступа к содержимому хранилища ключей: `STORE_PASS`. Пароли — это конфиденциальные значения, которые должны быть скрыты или опущены в файлах журнала. Подключаемый модуль Енвинжект можно настроить для защиты этих значений, чтобы они не отображались в журналах.

Непосредственно перед разделом **Build** в конфигурации задания является раздел **среды сборки** . Когда флажок **Вставить пароли** переключен, отображаются некоторые поля формы. Эти поля формы используются для записи имени и значения переменной среды. На следующем снимке экрана приведен пример добавления переменной среды `STORE_PASS`:

![](jenkins-walkthrough-images/image41.png "This screenshot is an example of adding the STOREPASS environment variable")

После инициализации переменных среды следующим шагом является добавление шага сборки для подписывания и ZIP-файла, выравниваемая APK. Сразу после шага сборки, чтобы вставить переменные среды, это будет другая команда **выполнить сборку оболочки** , которая будет выполняться `jarsigner` и `zipalign`. Каждая команда займет одну строку, как показано в следующем фрагменте кода:

```
jarsigner -verbose -sigalg MD5withRSA -digestalg SHA1 -keystore $KEYSTORE_FILE -storepass $STORE_PASS -signedjar $SIGNED_APK $INPUT_APK $KEYSTORE_ALIAS
zipalign -f -v 4 $SIGNED_APK $FINAL_APK
```

На следующем снимке экрана показан пример того, как ввести `jarsigner` и `zipalign` команды на шаге:

![](jenkins-walkthrough-images/image42.png "This screenshot shows an example of how to enter the jarsigner and zipalign commands into the step")

После выполнения всех действий сборки рекомендуется запустить ручную сборку, чтобы убедиться в том, что все работает. В случае сбоя сборки необходимо проверить **выходные данные консоли** , чтобы получить сведения о том, что привело к сбою сборки.

### <a name="submitting-tests-to-test-cloud"></a>Отправка тестов в Test Cloud

Автоматические тесты можно отправлять в Test Cloud с помощью команд оболочки. Дополнительные сведения о настройке тестового запуска в Xamarin Test Cloud см. в этом пошаговом руководству по использованию [Xamarin. uitest](/appcenter/test-cloud/preparing-for-upload/uitest/).

## <a name="summary"></a>Сводка

В этом пошаговом руководством мы предоставили Jenkins в качестве сервера сборки на macOS и настроили его для компиляции и подготовки мобильных приложений Xamarin для выпуска. Мы установили Jenkins на компьютере macOS вместе с несколькими подключаемыми модулями для поддержки процесса сборки. Мы создали и настроили задание, которое будет извлекать код из TFS или Git, а затем компилировать этот код в приложение, готовое к выпуску. Мы также изучили два разных способа планирования выполнения заданий.

## <a name="related-links"></a>Связанные ссылки

- [Непрерывная интеграция](~/tools/ci/index.md)
- [Тестирование Центра приложений](https://docs.microsoft.com/appcenter/test-cloud/)
