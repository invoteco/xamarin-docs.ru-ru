---
title: Аусентикатеусерс с поставщиком удостоверений
description: В этой статье объясняется, как использовать Xamarin. auth для управления процессом проверки подлинности в приложении Xamarin. Forms.
ms.prod: xamarin
ms.assetid: D44745D5-77BB-4596-9B8C-EC75C259157C
ms.technology: xamarin-forms
author: davidbritch
ms.author: dabritch
ms.date: 11/07/2019
ms.openlocfilehash: 83fbad8a9bbb9afef5ee80705fe9e86e51284e7d
ms.sourcegitcommit: efbc69acf4ea484d8815311b058114379c9db8a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73842986"
---
# <a name="authenticate-users-with-an-identity-provider"></a>Проверка подлинности пользователей с помощью поставщика удостоверений

[![Загрузить образец](~/media/shared/download.png) загрузить пример](https://docs.microsoft.com/samples/xamarin/xamarin-forms-samples/webservices-oauthnativeflow)

_Xamarin. auth — это кросс-платформенный пакет SDK для проверки подлинности пользователей и хранения учетных записей. Он включает в себя средства проверки подлинности OAuth, обеспечивающие поддержку использования поставщиков удостоверений, таких как Google, Microsoft, Facebook и Twitter. В этой статье объясняется, как использовать Xamarin. auth для управления процессом проверки подлинности в приложении Xamarin. Forms._

OAuth является открытым стандартом для проверки подлинности и позволяет владельцу ресурса уведомлять поставщика ресурсов о том, что разрешение должно предоставляться сторонним лицам для доступа к информации без предоставления удостоверения владельцев ресурсов. Например, пользователь может уведомить поставщика удостоверений (например, Google, Microsoft, Facebook или Twitter) о том, что разрешение должно быть предоставлено приложению для доступа к своим данным, без предоставления удостоверения пользователя. Он обычно используется в качестве подхода для входа пользователей на веб-сайты и приложения с помощью поставщика удостоверений, но без предоставления пароля веб-сайту или приложению.

Общий обзор потока проверки подлинности при использовании поставщика удостоверений OAuth выглядит следующим образом:

1. Приложение переходит в браузер по URL-адресу поставщика удостоверений.
1. Поставщик удостоверений обрабатывает проверку подлинности пользователя и возвращает приложению код авторизации.
1. Приложение обменивается кодом авторизации для маркера доступа от поставщика удостоверений.
1. Приложение использует маркер доступа для доступа к API поставщика удостоверений, например API для запроса основных пользовательских данных.

Пример приложения демонстрирует использование Xamarin. auth для реализации собственного потока проверки подлинности в Google. Хотя Google используется в качестве поставщика удостоверений в этом разделе, подход применим и к другим поставщикам удостоверений. Дополнительные сведения о проверке подлинности с помощью конечной точки OAuth 2,0 в Google см. [в статье использование OAuth 2.0 для доступа к Google API](https://developers.google.com/identity/protocols/OAuth2) на веб-сайте Google.

> [!NOTE]
> В iOS 9 и более поздних версиях Защита транспорта приложений (ATS) обеспечивает безопасное подключение между Интернет-ресурсами (например, серверным сервером приложения) и приложением, тем самым предотвращая случайное раскрытие конфиденциальной информации. Поскольку ATS включена по умолчанию в приложениях, созданных для iOS 9, все подключения будут подвергаться требованиям безопасности ATS. Если соединения не соответствуют этим требованиям, они завершатся сбоем с исключением.
> ATS можно отключать, если невозможно использовать протокол `HTTPS` и безопасное взаимодействие с Интернет-ресурсами. Это можно сделать, обновив файл **info. plist** приложения. Дополнительные сведения см. в статье [Безопасность транспорта приложений](~/ios/app-fundamentals/ats.md).

## <a name="using-xamarinauth-to-authenticate-users"></a>Использование Xamarin. auth для проверки подлинности пользователей

Xamarin. auth поддерживает два подхода к взаимодействию приложений с конечной точкой авторизации поставщика удостоверений.

1. Использование встроенного веб-представления. Хотя это и распространенная практика, она больше не рекомендуется по следующим причинам:

    - Приложение, в котором размещается веб-представление, может получить доступ к учетным данным полной проверки подлинности пользователя, а не только к предоставлению авторизации OAuth, предназначенному для приложения. Это нарушает принцип минимальных привилегий, так как приложение имеет доступ к более мощным учетным данным, чем требуется, что может увеличить область атаки приложения.
    - Ведущее приложение может собирать имена пользователей и пароли, автоматически отправлять формы и обходить пользователей, а также копировать файлы cookie сеанса и использовать их для выполнения прошедших проверку подлинности действий от имени пользователя.
    - Встроенные веб-представления не используют состояние проверки подлинности совместно с другими приложениями или веб-браузером устройства, поэтому пользователь должен войти в систему для каждого запроса авторизации, который считается неограниченным пользовательским интерфейсом.
    - Некоторые конечные точки авторизации принимают меры для обнаружения и блокировки запросов авторизации, поступающих из веб-представлений.

1. Использование веб-браузера устройства — это рекомендуемый подход. Использование обозревателя устройств для запросов OAuth повышает удобство использования приложения, так как пользователям необходимо только войти в поставщик удостоверений на устройство, что повышает скорость преобразования потоков входа и авторизации в приложении. Обозреватель устройств также обеспечивает улучшенную безопасность, так как приложения могут проверять и изменять содержимое в веб-представлении, но не в браузере. Этот подход используется в этой статье и в примере приложения.

Общий обзор того, как пример приложения использует Xamarin. auth для проверки подлинности пользователей и получения базовых данных, показан на следующей схеме:

![](oauth-images/google-auth.png "Using Xamarin.Auth to Authenticate with Google")

Приложение выполняет запрос проверки подлинности в Google с помощью класса `OAuth2Authenticator`. Ответ на проверку подлинности возвращается, когда пользователь успешно прошел проверку подлинности в Google с помощью страницы входа, которая содержит маркер доступа. Затем приложение выполняет запрос к Google для основных пользовательских данных с помощью класса `OAuth2Request` с маркером доступа, включаемым в запрос.

### <a name="setup"></a>Установка

Для интеграции Google-входа с приложением Xamarin. Forms необходимо создать проект консоли Google API. Это можно обеспечить, выполнив следующие действия.

1. Перейдите на веб-сайт [Google API console](https://console.developers.google.com) и выполните вход с учетными данными учетной записи Google.
1. В раскрывающемся списке Проект выберите существующий проект или создайте новый.
1. На боковой панели в разделе "Диспетчер API" выберите **учетные данные**, а затем перейдите на **вкладку экран согласия OAuth**. Выберите **адрес электронной почты**, укажите **имя продукта, которое отображается для пользователей**, и нажмите кнопку **сохранить**.
1. На вкладке **учетные данные** выберите в раскрывающемся списке **создать учетные данные** и щелкните **идентификатор клиента OAuth**.
1. В разделе **Тип приложения**выберите платформу, на которой будет выполняться мобильное приложение (**iOS** или **Android**).
1. Введите необходимые сведения и нажмите кнопку **создать** .

> [!NOTE]
> Идентификатор клиента позволяет приложениям использовать API Google, а для мобильных приложений — уникально для одной платформы. Поэтому **идентификатор клиента OAuth** должен быть создан для каждой платформы, которая будет использовать вход Google.

После выполнения этих действий можно использовать Xamarin. auth для запуска потока проверки подлинности OAuth2 с помощью Google.

### <a name="creating-and-configuring-an-authenticator"></a>Создание и Настройка средства проверки подлинности

Класс `OAuth2Authenticator` Xamarin. auth отвечает за обработку потока проверки подлинности OAuth. В следующем примере кода показано создание экземпляра класса `OAuth2Authenticator` при выполнении проверки подлинности с помощью веб-браузера устройства:

```csharp
var authenticator = new OAuth2Authenticator(
    clientId,
    null,
    Constants.Scope,
    new Uri(Constants.AuthorizeUrl),
    new Uri(redirectUri),
    new Uri(Constants.AccessTokenUrl),
    null,
    true);
```

Класс `OAuth2Authenticator` требует несколько параметров, которые приведены ниже.

- **Идентификатор клиента** — определяет клиент, выполняющий запрос, и его можно получить из проекта в [консоли Google API](https://console.developers.google.com).
- **Секрет клиента** — это должен быть `null` или `string.Empty`.
- **Область** — определяет доступ API, запрашиваемый приложением, а значение информирует экран согласия, отображаемый пользователю. Дополнительные сведения об областях см. в разделе [авторизация запроса API](https://developers.google.com/+/web/api/rest/oauth) на веб-сайте Google.
- **Авторизация URL-адреса** — определяет URL-адрес, с которого будет получен код авторизации.
- **URL-адрес перенаправления** — определяет URL-адрес, по которому будет отправлен ответ. Значение этого параметра должно соответствовать одному из значений, отображаемых на вкладке **учетные данные** для проекта в [консоли Google Developers](https://console.developers.google.com/).
- **URL-адрес AccessToken** — определяет URL-адрес, используемый для запроса маркеров доступа после получения кода авторизации.
- **Жетусернамеасинк Func** — необязательный `Func`, который будет использоваться для асинхронного получения имени пользователя учетной записи после успешной проверки подлинности.
- **Использовать собственный пользовательский интерфейс** — `boolean` значение, указывающее, следует ли использовать веб-браузер устройства для выполнения запроса проверки подлинности.

### <a name="setup-authentication-event-handlers"></a>Настройка обработчиков событий проверки подлинности

Перед представлением пользовательского интерфейса необходимо зарегистрировать обработчик событий для события `OAuth2Authenticator.Completed`, как показано в следующем примере кода:

```csharp
authenticator.Completed += OnAuthCompleted;
```

Это событие срабатывает, когда пользователь успешно проходит проверку подлинности или отменяет вход.

При необходимости также можно зарегистрировать обработчик событий `OAuth2Authenticator.Error` события.

### <a name="presenting-the-sign-in-user-interface"></a>Представление пользовательского интерфейса для входа

Пользовательский интерфейс входа может быть представлен пользователю с помощью средства входа Xamarin. auth, которое должно быть инициализировано в каждом проекте платформы. В следующем примере кода показано, как инициализировать представление входа в класс `AppDelegate` в проекте iOS:

```csharp
global::Xamarin.Auth.Presenters.XamarinIOS.AuthenticationConfiguration.Init();
```

В следующем примере кода показано, как инициализировать представление входа в класс `MainActivity` в проекте Android:

```csharp
global::Xamarin.Auth.Presenters.XamarinAndroid.AuthenticationConfiguration.Init(this, bundle);
```

Затем проект библиотеки .NET Standard может вызвать представление входа в систему, как показано ниже.

```csharp
var presenter = new Xamarin.Auth.Presenters.OAuthLoginPresenter();
presenter.Login(authenticator);
```

Обратите внимание, что аргументом для метода `Xamarin.Auth.Presenters.OAuthLoginPresenter.Login` является экземпляр `OAuth2Authenticator`. При вызове метода `Login` пользовательский интерфейс входа предоставляется пользователю на вкладке из веб-браузера устройства, который показан на следующих снимках экрана:

![](oauth-images/login.png "Google Sign-In")

### <a name="processing-the-redirect-url"></a>Обработка URL-адреса перенаправления

После того как пользователь завершит процесс проверки подлинности, управление вернется в приложение с вкладки веб-браузер. Это достигается путем регистрации настраиваемой схемы URL-адреса перенаправления, которая возвращается из процесса проверки подлинности, а затем обнаружения и обработки настраиваемого URL-адреса после его отправки.

При выборе настраиваемой схемы URL-адресов для связи с приложением приложения должны использовать схему на основе имени под их контролем. Это можно сделать с помощью имени идентификатора пакета в iOS и имени пакета на устройстве Android, а затем изменить его, чтобы создать схему URL-адресов. Однако некоторые поставщики удостоверений, например Google, назначают идентификаторы клиентов на основе доменных имен, которые затем реверсируются и используются в качестве схемы URL-адресов. Например, если Google создает идентификатор клиента `902730282010-ks3kd03ksoasioda93jldas93jjj22kr.apps.googleusercontent.com`, схема URL-адресов будет `com.googleusercontent.apps.902730282010-ks3kd03ksoasioda93jldas93jjj22kr`. Обратите внимание, что после компонента схемы может появиться только одно `/`. Таким образом, полный пример URL-адреса перенаправления, использующего настраиваемую схему URL-адресов, `com.googleusercontent.apps.902730282010-ks3kd03ksoasioda93jldas93jjj22kr:/oauth2redirect`.

Когда веб-браузер получает ответ от поставщика удостоверений, содержащего настраиваемую схему URL-адресов, он пытается загрузить URL-адрес, что приведет к сбою. Вместо этого пользовательская схема URL-адресов сообщается операционной системе, вызывая событие. Операционная система проверяет наличие зарегистрированных схем и, если она найдена, операционная система запустит приложение, которое зарегистрировало схему, и отправит ему URL-адрес перенаправления.

Механизм регистрации настраиваемой схемы URL-адресов в операционной системе и обработки схемы зависит от конкретной платформы.

#### <a name="ios"></a>iOS

В iOS пользовательская схема URL-адресов регистрируется в файле **info. plist**, как показано на следующем снимке экрана:

![](oauth-images/info-plist.png "URL Scheme Registration")

Значение **идентификатора** может быть любым, а значение **роли** должно быть задано в **средстве просмотра**. Значение **схемы URL-адресов** , которое начинается с `com.googleusercontent.apps`, может быть получено из идентификатора клиента iOS для проекта в [консоли Google API](https://console.developers.google.com).

Когда поставщик удостоверений завершает запрос авторизации, он перенаправляется на URL-адрес перенаправления приложения. Поскольку URL-адрес использует пользовательскую схему, он приводит к запуску приложения iOS, передавая URL-адрес в качестве параметра запуска, где он обрабатывается `OpenUrl` переопределением класса `AppDelegate` приложения, которое показано в следующем примере кода. :

```csharp
public override bool OpenUrl(UIApplication app, NSUrl url, NSDictionary options)
{
    // Convert NSUrl to Uri
    var uri = new Uri(url.AbsoluteString);

    // Load redirectUrl page
    AuthenticationState.Authenticator.OnPageLoading(uri);

    return true;
}
```

Метод `OpenUrl` преобразует полученный URL-адрес из `NSUrl` в `Uri`.NET перед обработкой URL-адреса перенаправления с помощью метода `OnPageLoading` открытого объекта `OAuth2Authenticator`. В результате Xamarin. auth закрывает вкладку веб-браузер и анализирует полученные данные OAuth.

#### <a name="android"></a>Android

В Android пользовательская схема URL-адресов регистрируется путем указания атрибута [`IntentFilter`](xref:Android.App.IntentFilterAttribute) на `Activity`, который будет работать со схемой. Когда поставщик удостоверений завершает запрос авторизации, он перенаправляется на URL-адрес перенаправления приложения. Так как URL-адрес использует пользовательскую схему, он приводит к запуску приложения Android, передавая URL-адрес в качестве параметра запуска, где он обрабатывается методом `OnCreate` `Activity`, зарегистрированным для обработки настраиваемой схемы URL-адресов. В следующем примере кода показан класс из примера приложения, обрабатывающего пользовательскую схему URL-адресов:

```csharp
[Activity(Label = "CustomUrlSchemeInterceptorActivity", NoHistory = true, LaunchMode = LaunchMode.SingleTop )]
[IntentFilter(
    new[] { Intent.ActionView },
    Categories = new [] { Intent.CategoryDefault, Intent.CategoryBrowsable },
    DataSchemes = new [] { "<insert custom URL here>" },
    DataPath = "/oauth2redirect")]
public class CustomUrlSchemeInterceptorActivity : Activity
{
    protected override void OnCreate(Bundle savedInstanceState)
    {
        base.OnCreate(savedInstanceState);

        // Convert Android.Net.Url to Uri
        var uri = new Uri(Intent.Data.ToString());

        // Load redirectUrl page
        AuthenticationState.Authenticator.OnPageLoading(uri);

        Finish();
    }
}
```

Для свойства `DataSchemes` [`IntentFilter`](xref:Android.App.IntentFilterAttribute) необходимо задать обратный идентификатор клиента, полученный из идентификатора клиента Android для проекта в [консоли Google API](https://console.developers.google.com).

Метод `OnCreate` преобразует полученный URL-адрес из `Android.Net.Url` в `Uri`.NET перед обработкой URL-адреса перенаправления с помощью метода `OnPageLoading` открытого объекта `OAuth2Authenticator`. В результате Xamarin. auth закрывает вкладку веб-браузер и анализирует полученные данные OAuth.

> [!IMPORTANT]
> В Android Xamarin. auth использует API `CustomTabs` для взаимодействия с веб-браузером и операционной системой. Однако не гарантируется, что на устройстве пользователя будет установлен совместимый с `CustomTabs` браузер.

### <a name="examining-the-oauth-response"></a>Проверка ответа OAuth

После синтаксического анализа полученных данных OAuth Xamarin. auth вызовет событие `OAuth2Authenticator.Completed`. В обработчике событий для этого события можно использовать свойство `AuthenticatorCompletedEventArgs.IsAuthenticated`, чтобы определить, прошла ли проверка подлинности, как показано в следующем примере кода:

```csharp
async void OnAuthCompleted(object sender, AuthenticatorCompletedEventArgs e)
{
  ...
  if (e.IsAuthenticated)
  {
    ...
  }
}
```

Данные, собранные из успешной проверки подлинности, доступны в свойстве `AuthenticatorCompletedEventArgs.Account`. Сюда входит маркер доступа, который можно использовать для подписывания запросов данных в API, предоставляемый поставщиком удостоверений.

### <a name="making-requests-for-data"></a>Выполнение запросов к данным

Когда приложение получает маркер доступа, оно используется для выполнения запроса к `https://www.googleapis.com/oauth2/v2/userinfo` API, чтобы запросить базовые пользовательские данные от поставщика удостоверений. Этот запрос выполняется с помощью класса `OAuth2Request` Xamarin. auth, который представляет запрос, прошедший проверку подлинности с помощью учетной записи, полученной от экземпляра `OAuth2Authenticator`, как показано в следующем примере кода:

```csharp
// UserInfoUrl = https://www.googleapis.com/oauth2/v2/userinfo
var request = new OAuth2Request ("GET", new Uri (Constants.UserInfoUrl), null, e.Account);
var response = await request.GetResponseAsync ();
if (response != null)
{
  string userJson = response.GetResponseText ();
  var user = JsonConvert.DeserializeObject<User> (userJson);
}
```

Кроме метода HTTP и URL-адреса API, `OAuth2Request` экземпляр также указывает `Account` экземпляр, содержащий маркер доступа, который подписывает запрос на URL-адрес, указанный свойством `Constants.UserInfoUrl`. Затем поставщик удостоверений возвращает базовые данные пользователя в виде ответа JSON, включая имя и адрес электронной почты пользователей при условии, что маркер доступа распознан как допустимый. Затем ответ JSON считывается и десериализуется в переменную `user`.

Дополнительные сведения см. в статье [вызов Google API](https://developers.google.com/identity/protocols/OAuth2InstalledApp#callinganapi) на портале Google Developers.

### <a name="storing-and-retrieving-account-information-on-devices"></a>Хранение и получение сведений об учетной записи на устройствах

Xamarin. auth безопасно сохраняет `Account` объекты в хранилище учетных записей, чтобы приложениям не применялись повторные проверки подлинности пользователей. Класс `AccountStore` отвечает за хранение данных учетной записи и обеспечивается службами цепочки ключей в iOS, а класс `KeyStore` в Android.

В следующем примере кода показано, как безопасно сохранить объект `Account`:

```csharp
AccountStore.Create ().Save (e.Account, Constants.AppName);
```

Сохраненные учетные записи уникально идентифицируются с помощью ключа, состоящего из свойства `Username` учетной записи, и идентификатора службы, который представляет собой строку, используемую при выборке учетных записей из хранилища учетных записей. Если ранее был сохранен `Account`, вызов метода `Save` снова запишет его.

`Account` объекты для службы можно получить, вызвав метод `FindAccountsForService`, как показано в следующем примере кода:

```csharp
var account = AccountStore.Create ().FindAccountsForService (Constants.AppName).FirstOrDefault();
```

Метод `FindAccountsForService` Возвращает коллекцию `IEnumerable` объектов `Account`, в которой первый элемент коллекции задается как соответствующая учетная запись.

## <a name="troubleshooting"></a>Устранение неполадок

- В Android, если при закрытии браузера после проверки подлинности вы получаете всплывающее уведомление и хотите закрыть всплывающее уведомление, добавьте следующий код в проект Android после инициализации Xamarin. auth:

```csharp
Xamarin.Auth.CustomTabsConfiguration.CustomTabsClosingMessage = null;
```

- В Android, если браузер не закрывается автоматически, временное решение заключается в понижении уровня пакета Xamarin. auth до версии 1.5.0.3. Затем добавьте в проект Android 2.0.147 с помощью [PCL Crypto v](https://www.nuget.org/packages/PCLCrypto/2.0.147) .

## <a name="summary"></a>Сводка

В этой статье объясняется, как использовать Xamarin. auth для управления процессом проверки подлинности в приложении Xamarin. Forms. Xamarin. auth предоставляет классы `OAuth2Authenticator` и `OAuth2Request`, используемые приложениями Xamarin. Forms для использования поставщиков удостоверений, таких как Google, Microsoft, Facebook и Twitter.

## <a name="related-links"></a>Связанные ссылки

- [Оауснативефлов (пример)](https://docs.microsoft.com/samples/xamarin/xamarin-forms-samples/webservices-oauthnativeflow)
- [OAuth 2,0 для собственных приложений](https://tools.ietf.org/html/draft-ietf-oauth-native-apps-12)
- [Использование OAuth 2.0 для доступа к Google API](https://developers.google.com/identity/protocols/OAuth2)
- [Xamarin. auth (NuGet)](https://www.nuget.org/packages/xamarin.auth/)
- [Xamarin. auth (GitHub)](https://github.com/xamarin/Xamarin.Auth)
